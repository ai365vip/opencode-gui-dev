# Cursor å¼å·®å¼‚é¢„è§ˆåŠŸèƒ½éœ€æ±‚è§„æ ¼è¯´æ˜ä¹¦

## æ–‡æ¡£ä¿¡æ¯

- **é¡¹ç›®åç§°**: Claudix VSCode Extension - Cursor å¼å·®å¼‚é¢„è§ˆ
- **æ–‡æ¡£ç‰ˆæœ¬**: v1.1
- **åˆ›å»ºæ—¥æœŸ**: 2025-11-16
- **æœ€åæ›´æ–°**: 2025-11-16
- **æ–‡æ¡£çŠ¶æ€**: éœ€æ±‚å®šä¹‰
- **è´Ÿè´£äºº**: Claudix å¼€å‘å›¢é˜Ÿ
- **æ›´æ–°è¯´æ˜**: v1.1 - æ·»åŠ å·¥ä½œæ¨¡å¼é›†æˆï¼ˆdefault/agent/askï¼‰çš„è¯¦ç»†è¯´æ˜

---

## 1. é¡¹ç›®æ¦‚è¿°

### 1.1 èƒŒæ™¯

Cursor ç¼–è¾‘å™¨å®ç°äº†ä¸€ç§ä¼˜ç§€çš„ AI ä»£ç ä¿®æ”¹é¢„è§ˆæœºåˆ¶ï¼Œå…è®¸ç”¨æˆ·åœ¨ AI ä¿®æ”¹ä»£ç åï¼Œé€šè¿‡å¯è§†åŒ–çš„çº¢ç»¿å¯¹æ¯”å’Œç‹¬ç«‹çš„æ¥å—/æ‹’ç»æŒ‰é’®ï¼Œç²¾ç»†æ§åˆ¶æ¯ä¸€å¤„ä¿®æ”¹ã€‚è¿™ç§æœºåˆ¶æå¤§æå‡äº† AI è¾…åŠ©ç¼–ç¨‹çš„ç”¨æˆ·ä½“éªŒå’Œå®‰å…¨æ€§ã€‚

Claudix ä½œä¸ºåŸºäº Claude Agent SDK çš„ VSCode æ‰©å±•ï¼Œéœ€è¦å®ç°ç±»ä¼¼çš„å·®å¼‚é¢„è§ˆåŠŸèƒ½ï¼Œä»¥æä¾›æ›´å¥½çš„ç”¨æˆ·ä½“éªŒå’Œä¿®æ”¹æ§åˆ¶èƒ½åŠ›ã€‚

### 1.2 ç›®æ ‡

å®ç°å®Œæ•´çš„ Cursor å¼å·®å¼‚é¢„è§ˆåŠŸèƒ½ï¼ŒåŒ…æ‹¬ï¼š

1. **å¯è§†åŒ–å·®å¼‚å¯¹æ¯”**ï¼šAI ä¿®æ”¹æ–‡ä»¶åï¼Œåœ¨ç¼–è¾‘å™¨ä¸­æ˜¾ç¤ºçº¢è‰²ï¼ˆåˆ é™¤ï¼‰å’Œç»¿è‰²ï¼ˆæ–°å¢ï¼‰çš„å¯¹æ¯”æ ‡è®°
2. **ç‹¬ç«‹å—æ§åˆ¶**ï¼šæ¯ä¸ªä¿®æ”¹å—ç‹¬ç«‹ç®¡ç†ï¼Œæ”¯æŒå•ç‹¬æ¥å—æˆ–æ‹’ç»
3. **å¤šæ¬¡ä¿®æ”¹å åŠ **ï¼šæ”¯æŒåŒä¸€æ–‡ä»¶å¤šæ¬¡ä¿®æ”¹ï¼Œæ¯æ¬¡ä¿®æ”¹åˆ›å»ºç‹¬ç«‹çš„å·®å¼‚å—
4. **æ™ºèƒ½åŸºå‡†è¿½è¸ª**ï¼šåŒä½ç½®å¤šæ¬¡ä¿®æ”¹æ—¶ï¼Œæ­£ç¡®å¯¹æ¯”ä¸Šæ¬¡æ¥å—çŠ¶æ€å’Œæœ€æ–°ä¿®æ”¹
5. **é«˜æ€§èƒ½æ”¯æŒ**ï¼šå¤§æ–‡ä»¶ï¼ˆ>5000è¡Œï¼‰ä¹Ÿèƒ½æµç•…è¿è¡Œ
6. **å®Œæ•´çš„ç”¨æˆ·ä½“éªŒ**ï¼šå¿«æ·é”®ã€æ‰¹é‡æ“ä½œã€çŠ¶æ€æŒä¹…åŒ–

### 1.3 æ ¸å¿ƒä»·å€¼

- **å®‰å…¨æ€§**ï¼šç”¨æˆ·å¯ä»¥é€ä¸€å®¡æŸ¥æ¯ä¸ªä¿®æ”¹ï¼Œé¿å…è¯¯æ“ä½œ
- **å¯æ§æ€§**ï¼šæ”¯æŒéƒ¨åˆ†æ¥å—ã€éƒ¨åˆ†æ‹’ç»ï¼Œçµæ´»æ§åˆ¶ä»£ç å˜æ›´
- **å¯è¿½æº¯æ€§**ï¼šæ¸…æ™°å±•ç¤ºæ¯æ¬¡ä¿®æ”¹çš„å‰åå¯¹æ¯”
- **æ•ˆç‡**ï¼šå¿«æ·é”®å’Œæ‰¹é‡æ“ä½œæå‡å®¡æŸ¥æ•ˆç‡

---

## 2. æ ¸å¿ƒåŠŸèƒ½éœ€æ±‚

### 2.1 å·®å¼‚æ ‡è®°ç³»ç»Ÿ

#### 2.1.1 Conflict Marker æ ¼å¼

ä½¿ç”¨ç±»ä¼¼ Git merge conflict çš„æ ‡è®°æ ¼å¼ï¼š

```
<<<<<<< Original [block-{uuid}]
æ—§å†…å®¹è¡Œ1
æ—§å†…å®¹è¡Œ2
=======
æ–°å†…å®¹è¡Œ1
æ–°å†…å®¹è¡Œ2
>>>>>>> Claude's Change
```

**å…³é”®è®¾è®¡**ï¼š
- `block-{uuid}`: å”¯ä¸€æ ‡è¯†ç¬¦ï¼ŒåŸºäºæ–‡ä»¶è·¯å¾„ + èµ·å§‹è¡Œå· + æ—¶é—´æˆ³ç”Ÿæˆ
- æ ‡è®°è¡Œæœ¬èº«ä¸å‚ä¸æ¸²æŸ“ï¼Œé€šè¿‡è£…é¥°å™¨éšè—æˆ–æ·¡åŒ–æ˜¾ç¤º

#### 2.1.2 å¯è§†åŒ–æ¸²æŸ“

**è£…é¥°å™¨ç±»å‹**ï¼š

1. **åŸå§‹å†…å®¹è£…é¥°**ï¼ˆçº¢è‰²èƒŒæ™¯ï¼‰
   ```typescript
   backgroundColor: 'rgba(255, 0, 0, 0.2)'
   before: { contentText: '-', color: 'rgba(255, 0, 0, 0.8)' }
   ```

2. **æ–°å¢å†…å®¹è£…é¥°**ï¼ˆç»¿è‰²èƒŒæ™¯ï¼‰
   ```typescript
   backgroundColor: 'rgba(0, 255, 0, 0.2)'
   before: { contentText: '+', color: 'rgba(0, 255, 0, 0.8)' }
   ```

3. **æ ‡è®°è¡Œè£…é¥°**ï¼ˆç°è‰²èƒŒæ™¯ï¼ŒåŠé€æ˜ï¼‰
   ```typescript
   backgroundColor: 'rgba(128, 128, 128, 0.15)'
   color: 'rgba(128, 128, 128, 0.6)'
   ```

4. **æ¥å—åçš„æ·¡å…¥åŠ¨ç”»**
   - ç»¿è‰²èƒŒæ™¯æ¸å˜åˆ°é€æ˜ï¼ˆ500msï¼‰
   - æä¾›è§†è§‰åé¦ˆ

### 2.2 CodeLens äº¤äº’æŒ‰é’®

#### 2.2.1 å•å—æ“ä½œæŒ‰é’®

åœ¨æ¯ä¸ª conflict marker èµ·å§‹è¡Œä¸Šæ–¹æ˜¾ç¤ºï¼š

```
[1/5] âœ… æ¥å—  âŒ æ‹’ç»  ğŸ“‹ å¯¹æ¯”è¯¦æƒ…
```

**æŒ‰é’®å®šä¹‰**ï¼š

| æŒ‰é’® | åŠŸèƒ½ | å¿«æ·é”® | å‘½ä»¤ID |
|-----|------|--------|--------|
| âœ… æ¥å— | æ¥å—å½“å‰å—çš„ä¿®æ”¹ | Cmd+K (Mac) / Ctrl+K (Win) | `claudix.acceptDiffBlock` |
| âŒ æ‹’ç» | æ‹’ç»å½“å‰å—çš„ä¿®æ”¹ | Cmd+Shift+K | `claudix.rejectDiffBlock` |
| ğŸ“‹ å¯¹æ¯”è¯¦æƒ… | åœ¨ä¾§è¾¹æ æ˜¾ç¤ºè¯¦ç»† diff | - | `claudix.showBlockDetail` |

**è®¡æ•°å™¨æ˜¾ç¤º**ï¼š
- æ ¼å¼ï¼š`[å½“å‰å—åºå·/æ€»å—æ•°]`
- å®æ—¶æ›´æ–°ï¼ˆæ¥å—/æ‹’ç»åè‡ªåŠ¨åˆ·æ–°ï¼‰

#### 2.2.2 å…¨å±€æ“ä½œæŒ‰é’®

åœ¨æ–‡æ¡£é¡¶éƒ¨æ˜¾ç¤ºï¼ˆå½“å­˜åœ¨ â‰¥2 ä¸ªå—æ—¶ï¼‰ï¼š

```
ğŸ”„ å…¨éƒ¨æ¥å—  ğŸš« å…¨éƒ¨æ‹’ç»  ğŸ“Š æŸ¥çœ‹ç»Ÿè®¡
```

**å…¨å±€å‘½ä»¤**ï¼š

| å‘½ä»¤ | åŠŸèƒ½ | å¿«æ·é”® |
|-----|------|--------|
| å…¨éƒ¨æ¥å— | æ¥å—æ‰€æœ‰æœªå¤„ç†çš„å— | Cmd+Shift+A |
| å…¨éƒ¨æ‹’ç» | æ‹’ç»æ‰€æœ‰æœªå¤„ç†çš„å— | Cmd+Shift+R |
| æŸ¥çœ‹ç»Ÿè®¡ | æ˜¾ç¤ºä¿®æ”¹ç»Ÿè®¡ä¿¡æ¯ | - |

### 2.3 å¤šæ¬¡ä¿®æ”¹å åŠ æœºåˆ¶

#### 2.3.1 åœºæ™¯ç¤ºä¾‹

```
åˆå§‹çŠ¶æ€ï¼š
function foo() { return 1; }

AI ä¿®æ”¹ 1ï¼ˆåˆ›å»º block-abcï¼‰ï¼š
function foo() { return 2; }
â†’ æ–‡ä»¶å·²ä¿®æ”¹å¹¶ä¿å­˜
â†’ ç¼–è¾‘å™¨æ˜¾ç¤ºå¯¹æ¯”æ ‡è®°

ç”¨æˆ·æ¥å— block-abcï¼š
â†’ åˆ é™¤æ ‡è®°ï¼Œä¿ç•™ä¿®æ”¹
â†’ æ›´æ–°åŸºå‡†çŠ¶æ€ = { return 2; }

AI ä¿®æ”¹ 2ï¼ˆåŒä¸€ä½ç½®ï¼Œåˆ›å»º block-defï¼‰ï¼š
function foo() { return 3; }
â†’ åŸºå‡†å¯¹æ¯”ï¼š{ return 2; } vs { return 3; }
â†’ è€Œä¸æ˜¯ï¼š{ return 1; } vs { return 3; }
```

#### 2.3.2 Block ID ç”Ÿæˆè§„åˆ™

```typescript
function generateBlockId(filePath: string, startLine: number): string {
  const fileHash = hashString(filePath).slice(0, 8);
  const timestamp = Date.now();
  return `block-${fileHash}-${startLine}-${timestamp}`;
}
```

**å…³é”®è®¾è®¡**ï¼š
- åŒ…å«æ—¶é—´æˆ³ï¼Œç¡®ä¿å¤šæ¬¡ä¿®æ”¹åŒä¸€ä½ç½®æ—¶ ID å”¯ä¸€
- ä½†é€šè¿‡ `startLine` å¯ä»¥è¯†åˆ«"åŒä½ç½®ä¿®æ”¹"

#### 2.3.3 åŸºå‡†çŠ¶æ€è¿½è¸ª

**æ•°æ®ç»“æ„**ï¼š

```typescript
interface BlockBaseState {
  blockId: string;
  baseContent: string;      // å¯¹æ¯”åŸºå‡†
  baseType: 'original' | 'accepted';  // åŸºå‡†æ¥æº
  lastAcceptedBlockId?: string;  // å¦‚æœåŸºå‡†æ˜¯æ¥å—åçš„ï¼Œè®°å½•é‚£ä¸ª block çš„ ID
}
```

**æ›´æ–°è§„åˆ™**ï¼š

1. **é¦–æ¬¡ä¿®æ”¹**ï¼šbaseContent = åŸå§‹å†…å®¹ï¼ŒbaseType = 'original'
2. **æ¥å—åå†ä¿®æ”¹**ï¼šbaseContent = æ¥å—çš„å†…å®¹ï¼ŒbaseType = 'accepted'
3. **æ‹’ç»åå†ä¿®æ”¹**ï¼šbaseContent ä¸å˜ï¼ˆå›é€€åˆ°ä¸Šä¸€ä¸ªåŸºå‡†ï¼‰

### 2.4 æ–‡ä»¶çŠ¶æ€åŒæ­¥

#### 2.4.1 ä¸‰å±‚çŠ¶æ€ç®¡ç†

```
Layer 1: ç£ç›˜æ–‡ä»¶ï¼ˆDiskï¼‰
  â†“
  å®é™…ä¿å­˜çš„å†…å®¹ï¼ˆAI ä¿®æ”¹åçš„æœ€ç»ˆç»“æœï¼‰

Layer 2: ç¼–è¾‘å™¨ç¼“å†²åŒºï¼ˆEditor Bufferï¼‰
  â†“
  åŒ…å« conflict markers çš„å†…å®¹
  ç”¨æˆ·çœ‹åˆ°çš„å†…å®¹

Layer 3: çŠ¶æ€ç¼“å­˜ï¼ˆState Cacheï¼‰
  â†“
  æ‰€æœ‰ blocks çš„å…ƒæ•°æ®ã€åŸºå‡†å†…å®¹ã€çŠ¶æ€
```

#### 2.4.2 åŒæ­¥æ—¶æœº

| äº‹ä»¶ | Layer 1 | Layer 2 | Layer 3 |
|-----|---------|---------|---------|
| AI ä¿®æ”¹æ–‡ä»¶ | âœ… æ›´æ–° | âœ… æ’å…¥ markers | âœ… åˆ›å»º block |
| ç”¨æˆ·æ¥å—å— | âŒ ä¸å˜ | âœ… åˆ é™¤ markers | âœ… æ›´æ–°çŠ¶æ€ |
| ç”¨æˆ·æ‹’ç»å— | âœ… å›æ»š | âœ… åˆ é™¤ markers | âœ… æ›´æ–°çŠ¶æ€ |
| ç”¨æˆ·ä¿å­˜æ–‡ä»¶ | âœ… ä¿å­˜ Layer 2 | âŒ ä¸å˜ | âŒ ä¸å˜ |

**å…³é”®è®¾è®¡**ï¼š
- æ–‡ä»¶å§‹ç»ˆä¿æŒ"ä¿®æ”¹å"çŠ¶æ€ï¼ˆCursor çš„æ ¸å¿ƒæœºåˆ¶ï¼‰
- æ‹’ç»æ“ä½œé€šè¿‡ WorkspaceEdit å›æ»šç£ç›˜æ–‡ä»¶

### 2.5 æ€§èƒ½ä¼˜åŒ–

#### 2.5.1 å¤§æ–‡ä»¶å¤„ç†ç­–ç•¥

**é™åˆ¶è§„åˆ™**ï¼š

| æ–‡ä»¶å¤§å° | æœ€å¤§ Block æ•° | Diff ç®—æ³• | è£…é¥°å™¨ç­–ç•¥ |
|---------|-------------|----------|-----------|
| < 1000 è¡Œ | æ— é™åˆ¶ | Myers Diff | å…¨é‡æ¸²æŸ“ |
| 1000-5000 è¡Œ | 50 ä¸ª | Myers Diff | å¯è§åŒºåŸŸä¼˜å…ˆ |
| > 5000 è¡Œ | 20 ä¸ª | å¢é‡ Diff | è™šæ‹Ÿæ»šåŠ¨ |

**è¶…é™å¤„ç†**ï¼š
```
æ£€æµ‹åˆ° 52 å¤„ä¿®æ”¹ï¼ˆé™åˆ¶ä¸º 50 ä¸ªï¼‰
[æ˜¾ç¤ºå‰ 50 ä¸ª] [å…¨éƒ¨æ¥å—] [å…¨éƒ¨æ‹’ç»]
```

#### 2.5.2 Diff ç®—æ³•ä¼˜åŒ–

**ä½¿ç”¨ Myers Diff ç®—æ³•**ï¼š

```typescript
import { diffLines } from 'diff';  // npm: diff

function calculateDiff(oldContent: string, newContent: string): DiffBlock[] {
  const patches = diffLines(oldContent, newContent);

  // Myers å¤æ‚åº¦ï¼šO(n * d)ï¼Œå…¶ä¸­ d æ˜¯ç¼–è¾‘è·ç¦»
  // å…¸å‹åœºæ™¯ï¼šd << nï¼Œæ¥è¿‘ O(n)

  return this.convertPatchesToBlocks(patches);
}
```

**å¢é‡ Diff**ï¼ˆé’ˆå¯¹è¶…å¤§æ–‡ä»¶ï¼‰ï¼š

```typescript
function incrementalDiff(
  oldContent: string,
  newContent: string,
  changedRanges: vscode.Range[]
): DiffBlock[] {
  // åªå¯¹å˜åŒ–èŒƒå›´ Â±50 è¡Œè¿›è¡Œ diff
  const blocks: DiffBlock[] = [];

  for (const range of changedRanges) {
    const expandedRange = expandRange(range, 50);
    const oldChunk = extractLines(oldContent, expandedRange);
    const newChunk = extractLines(newContent, expandedRange);

    blocks.push(...diffLines(oldChunk, newChunk));
  }

  return blocks;
}
```

#### 2.5.3 è£…é¥°å™¨è™šæ‹Ÿæ»šåŠ¨

**ä»…æ¸²æŸ“å¯è§åŒºåŸŸ**ï¼š

```typescript
function updateDecorations(editor: vscode.TextEditor) {
  const visibleRanges = editor.visibleRanges;
  const blocks = this.getBlocksInRanges(visibleRanges);

  // ä»…ä¸ºå¯è§ blocks è®¾ç½®è£…é¥°å™¨
  const decorations = blocks.map(block => ({
    range: block.range,
    hoverMessage: block.summary
  }));

  editor.setDecorations(this.decorationType, decorations);
}

// ç›‘å¬æ»šåŠ¨äº‹ä»¶
vscode.window.onDidChangeTextEditorVisibleRanges(event => {
  this.updateDecorations(event.textEditor);
});
```

### 2.6 å¿«æ·é”®æ”¯æŒ

#### 2.6.1 å®Œæ•´å¿«æ·é”®åˆ—è¡¨

| åŠŸèƒ½ | macOS | Windows/Linux | ä¸Šä¸‹æ–‡è¦æ±‚ |
|-----|-------|---------------|----------|
| æ¥å—å½“å‰å— | Cmd+K | Ctrl+K | å…‰æ ‡åœ¨ block å†… |
| æ‹’ç»å½“å‰å— | Cmd+Shift+K | Ctrl+Shift+K | å…‰æ ‡åœ¨ block å†… |
| è·³åˆ°ä¸‹ä¸€ä¸ªå— | Cmd+] | Ctrl+] | æ–‡ä»¶æœ‰ blocks |
| è·³åˆ°ä¸Šä¸€ä¸ªå— | Cmd+[ | Ctrl+[ | æ–‡ä»¶æœ‰ blocks |
| æ¥å—æ‰€æœ‰ | Cmd+Shift+A | Ctrl+Shift+A | æ–‡ä»¶æœ‰ blocks |
| æ‹’ç»æ‰€æœ‰ | Cmd+Shift+R | Ctrl+Shift+R | æ–‡ä»¶æœ‰ blocks |
| åˆ‡æ¢é¢„è§ˆæ¨¡å¼ | Cmd+Option+P | Ctrl+Alt+P | å…¨å±€ |

#### 2.6.2 æ™ºèƒ½å…‰æ ‡å®šä½

```typescript
// æ¥å—/æ‹’ç»åï¼Œå…‰æ ‡è‡ªåŠ¨è·³åˆ°ä¸‹ä¸€ä¸ª block
async acceptBlock(blockId: string) {
  await this.removeBlockMarkers(blockId);

  const nextBlock = this.getNextBlock(blockId);
  if (nextBlock) {
    this.moveCursorToBlock(nextBlock.id);
  }
}
```

### 2.7 çŠ¶æ€æŒä¹…åŒ–

#### 2.7.1 ä¿å­˜æ—¶æœº

- VSCode é€€å‡ºå‰è‡ªåŠ¨ä¿å­˜
- æ¯æ¬¡æ¥å—/æ‹’ç»æ“ä½œåä¿å­˜
- æ¯ 30 ç§’è‡ªåŠ¨ä¿å­˜ä¸€æ¬¡ï¼ˆé˜²æ­¢å´©æºƒä¸¢å¤±ï¼‰

#### 2.7.2 å­˜å‚¨æ ¼å¼

**ä½ç½®**: `.vscode/claudix-diff-state.json`

```json
{
  "version": "1.0",
  "files": {
    "src/App.tsx": {
      "blocks": [
        {
          "id": "block-a1b2c3d4-10-1700123456789",
          "startLine": 10,
          "endLine": 15,
          "baseContent": "const foo = 1;",
          "currentContent": "const foo = 2;",
          "status": "pending",
          "createdAt": 1700123456789,
          "lastModified": 1700123456789
        }
      ],
      "originalContent": "/* å®Œæ•´çš„åŸå§‹æ–‡ä»¶å†…å®¹ */",
      "lastSyncTime": 1700123456789
    }
  }
}
```

#### 2.7.3 æ¢å¤é€»è¾‘

```typescript
// VSCode å¯åŠ¨æ—¶
async restoreState() {
  const state = await this.loadStateFromDisk();

  for (const [filePath, fileState] of Object.entries(state.files)) {
    const doc = await vscode.workspace.openTextDocument(filePath);

    // æ£€æŸ¥æ–‡ä»¶æ˜¯å¦è¢«å¤–éƒ¨ä¿®æ”¹
    if (this.isFileModifiedExternally(doc, fileState)) {
      // æç¤ºç”¨æˆ·é€‰æ‹©ï¼šä¿ç•™çŠ¶æ€ or ä¸¢å¼ƒçŠ¶æ€
      await this.promptRestoreChoice(filePath);
    } else {
      // è‡ªåŠ¨æ¢å¤ markers
      await this.restoreMarkersForFile(filePath, fileState);
    }
  }
}
```

### 2.8 é”™è¯¯å¤„ç†å’Œå®¹é”™

#### 2.8.1 Marker æ ¼å¼æ ¡éªŒ

```typescript
function validateConflictMarkers(doc: vscode.TextDocument): ValidationResult {
  const lines = doc.getText().split('\n');
  const errors: MarkerError[] = [];

  for (let i = 0; i < lines.length; i++) {
    if (lines[i].startsWith('<<<<<<<')) {
      // æ£€æŸ¥æ˜¯å¦æœ‰å¯¹åº”çš„ ======= å’Œ >>>>>>>
      const separatorIndex = findNextLine(lines, i, '=======');
      const endIndex = findNextLine(lines, i, '>>>>>>>');

      if (separatorIndex === -1 || endIndex === -1) {
        errors.push({
          line: i,
          type: 'incomplete_marker',
          message: 'Conflict marker æ ¼å¼ä¸å®Œæ•´'
        });
      }

      if (separatorIndex > endIndex) {
        errors.push({
          line: i,
          type: 'invalid_order',
          message: 'Marker é¡ºåºé”™è¯¯'
        });
      }
    }
  }

  return { valid: errors.length === 0, errors };
}
```

#### 2.8.2 ç”¨æˆ·æ‰‹åŠ¨ç¼–è¾‘æ£€æµ‹

```typescript
vscode.workspace.onDidChangeTextDocument(event => {
  if (this.isUserEdit(event)) {
    // ç”¨æˆ·æ‰‹åŠ¨ç¼–è¾‘äº†å¸¦ markers çš„æ–‡ä»¶
    const affectedBlocks = this.findAffectedBlocks(event);

    for (const block of affectedBlocks) {
      if (this.isMarkerDamaged(block)) {
        // Marker è¢«ç ´åï¼Œæ ‡è®°ä¸ºå¤±æ•ˆ
        this.invalidateBlock(block.id);

        vscode.window.showWarningMessage(
          `æ£€æµ‹åˆ° ${block.filePath} çš„å·®å¼‚æ ‡è®°è¢«æ‰‹åŠ¨ä¿®æ”¹ï¼Œå·²è‡ªåŠ¨æ¸…ç†è¯¥å—`,
          'æ’¤é”€ç¼–è¾‘', 'å¿½ç•¥'
        );
      }
    }
  }
});
```

#### 2.8.3 AI ä¿®æ”¹å†²çªå¤„ç†

**åœºæ™¯**ï¼šç”¨æˆ·è¿˜æœªå¤„ç†å®Œä¸Šæ¬¡çš„ blocksï¼ŒAI åˆä¿®æ”¹äº†åŒä¸€æ–‡ä»¶

**ç­–ç•¥**ï¼š

```typescript
async onAIModifyFile(filePath: string) {
  const existingBlocks = this.getBlocks(filePath);

  if (existingBlocks.length > 0) {
    // æœ‰æœªå¤„ç†çš„ blocks
    const choice = await vscode.window.showWarningMessage(
      `${path.basename(filePath)} è¿˜æœ‰ ${existingBlocks.length} å¤„æœªç¡®è®¤çš„ä¿®æ”¹`,
      'å…ˆå¤„ç†æ—§ä¿®æ”¹', 'ç»§ç»­ï¼ˆä¼šå åŠ ï¼‰', 'æ¸…ç©ºæ—§ä¿®æ”¹'
    );

    if (choice === 'æ¸…ç©ºæ—§ä¿®æ”¹') {
      await this.clearAllBlocks(filePath);
    } else if (choice === 'å…ˆå¤„ç†æ—§ä¿®æ”¹') {
      return;  // ä¸­æ­¢æœ¬æ¬¡ä¿®æ”¹
    }
    // 'ç»§ç»­' åˆ™æ­£å¸¸å åŠ 
  }

  // æ­£å¸¸å¤„ç† AI ä¿®æ”¹
  await this.processAIEdit(filePath);
}
```

### 2.9 å·¥ä½œæ¨¡å¼é›†æˆ

#### 2.9.1 å·¥ä½œæ¨¡å¼å®šä¹‰

Claudix æ”¯æŒä¸‰ç§å·¥ä½œæ¨¡å¼ï¼Œé€šè¿‡è¾“å…¥æ¡†æ—çš„æ¨¡å¼é€‰æ‹©å™¨åˆ‡æ¢ï¼š

| æ¨¡å¼ | å›¾æ ‡ | è¯´æ˜ | å·®å¼‚é¢„è§ˆè¡Œä¸º |
|-----|------|------|------------|
| **Default** | ğŸ” | é»˜è®¤æ¨¡å¼ | âœ… **å¯ç”¨å·®å¼‚é¢„è§ˆ**<br>æ˜¾ç¤º conflict markers<br>éœ€è¦ç”¨æˆ·é€ä¸€ç¡®è®¤ |
| **Agent** | ğŸ¤– | è‡ªä¸»æ¨¡å¼ | âŒ **ç¦ç”¨å·®å¼‚é¢„è§ˆ**<br>AI ä¿®æ”¹ç›´æ¥åº”ç”¨<br>æ— éœ€ç”¨æˆ·ç¡®è®¤ |
| **Ask** | â“ | è¯¢é—®æ¨¡å¼ | âš ï¸ **æ¯æ¬¡ä¿®æ”¹å‰è¯¢é—®**<br>å¼¹çª—è®©ç”¨æˆ·é€‰æ‹©æ˜¯å¦é¢„è§ˆ |

#### 2.9.2 Default æ¨¡å¼ï¼ˆå·®å¼‚é¢„è§ˆï¼‰

**è¡Œä¸ºæµç¨‹**ï¼š

```
1. ç”¨æˆ·å‘é€æ¶ˆæ¯ï¼ˆæ¨¡å¼é€‰æ‹©å™¨æ˜¾ç¤º "Default"ï¼‰
   â†“
2. AI è°ƒç”¨ Write/Edit å·¥å…·
   â†“
3. ClaudeAgentService æ£€æµ‹åˆ° workMode = 'default'
   â†“
4. æ ‡è®°æ–‡ä»¶ï¼šDiffPreviewService.markFileForAIEdit(filePath)
   â†“
5. å·¥å…·çœŸå®æ‰§è¡Œï¼Œæ–‡ä»¶è¢«ä¿®æ”¹
   â†“
6. DiffPreviewService æ‹¦æˆªä¿®æ”¹
   â†“
7. è®¡ç®— diffï¼Œæ’å…¥ conflict markers
   â†“
8. æ˜¾ç¤ºçº¢ç»¿å¯¹æ¯” + CodeLens æŒ‰é’®
   â†“
9. ç”¨æˆ·é€ä¸€æ¥å—/æ‹’ç»ä¿®æ”¹
```

**å…³é”®ç‰¹æ€§**ï¼š
- âœ… å®Œæ•´çš„å·®å¼‚é¢„è§ˆåŠŸèƒ½
- âœ… çº¢ç»¿é«˜äº®æ˜¾ç¤º
- âœ… CodeLens æŒ‰é’®ï¼ˆæ¥å—/æ‹’ç»ï¼‰
- âœ… æ”¯æŒå¤šæ¬¡ä¿®æ”¹å åŠ 
- âœ… çŠ¶æ€æŒä¹…åŒ–

**ç”¨æˆ·ä½“éªŒ**ï¼š
```
ç¼–è¾‘å™¨æ˜¾ç¤ºï¼š
  <<<<<<< Original [block-abc]
  - const x = 1;
  =======
  + const x = 2;
  >>>>>>> Claude's Change

çŠ¶æ€æ ï¼š
  [Claudix] ğŸ“ 3 å¤„å¾…ç¡®è®¤ä¿®æ”¹ | [æ¥å— Cmd+K]
```

#### 2.9.3 Agent æ¨¡å¼ï¼ˆè‡ªåŠ¨åº”ç”¨ï¼‰

**è¡Œä¸ºæµç¨‹**ï¼š

```
1. ç”¨æˆ·å‘é€æ¶ˆæ¯ï¼ˆæ¨¡å¼é€‰æ‹©å™¨æ˜¾ç¤º "Agent"ï¼‰
   â†“
2. AI è°ƒç”¨ Write/Edit å·¥å…·
   â†“
3. ClaudeAgentService æ£€æµ‹åˆ° workMode = 'agent'
   â†“
4. è·³è¿‡å·®å¼‚é¢„è§ˆé€»è¾‘
   â†“
5. å·¥å…·ç›´æ¥æ‰§è¡Œï¼Œæ–‡ä»¶è¢«ä¿®æ”¹
   â†“
6. æ˜¾ç¤ºç®€å•çš„æˆåŠŸæç¤º
   â†“
7. AI ç»§ç»­åç»­æ“ä½œï¼ˆæ— éœ€ç­‰å¾…ç”¨æˆ·ç¡®è®¤ï¼‰
```

**å…³é”®ç‰¹æ€§**ï¼š
- âŒ **ä¸æ˜¾ç¤º conflict markers**
- âŒ **ä¸æ˜¾ç¤ºçº¢ç»¿å¯¹æ¯”**
- âŒ **ä¸æ˜¾ç¤º CodeLens æŒ‰é’®**
- âœ… ä¿®æ”¹ç«‹å³ç”Ÿæ•ˆï¼Œæ— éœ€ç¡®è®¤
- âœ… å¯é€‰ï¼šæ˜¾ç¤ºç®€å•çš„é€šçŸ¥ï¼ˆ"å·²è‡ªåŠ¨åº”ç”¨ 3 å¤„ä¿®æ”¹"ï¼‰

**ç”¨æˆ·ä½“éªŒ**ï¼š
```
ç¼–è¾‘å™¨æ˜¾ç¤ºï¼š
  const x = 2;  // ç›´æ¥æ˜¯ä¿®æ”¹åçš„å†…å®¹ï¼Œæ— æ ‡è®°

çŠ¶æ€æ ï¼š
  [Claudix] âœ… å·²è‡ªåŠ¨åº”ç”¨ 3 å¤„ä¿®æ”¹
```

**é€‚ç”¨åœºæ™¯**ï¼š
- ä¿¡ä»» AI çš„ä¿®æ”¹
- å¿«é€ŸåŸå‹å¼€å‘
- æ‰¹é‡é‡æ„ä»»åŠ¡
- ç´§æ€¥ bug ä¿®å¤

#### 2.9.4 Ask æ¨¡å¼ï¼ˆæŒ‰éœ€é€‰æ‹©ï¼‰

**è¡Œä¸ºæµç¨‹**ï¼š

```
1. ç”¨æˆ·å‘é€æ¶ˆæ¯ï¼ˆæ¨¡å¼é€‰æ‹©å™¨æ˜¾ç¤º "Ask"ï¼‰
   â†“
2. AI è°ƒç”¨ Write/Edit å·¥å…·
   â†“
3. ClaudeAgentService æ£€æµ‹åˆ° workMode = 'ask'
   â†“
4. å¼¹çª—è¯¢é—®ç”¨æˆ·ï¼š
   "AI å³å°†ä¿®æ”¹ 3 ä¸ªæ–‡ä»¶ï¼Œæ‚¨å¸Œæœ›ï¼š"
   [æ˜¾ç¤ºå·®å¼‚é¢„è§ˆ] [ç›´æ¥åº”ç”¨] [å–æ¶ˆ]
   â†“
5a. ç”¨æˆ·é€‰æ‹© "æ˜¾ç¤ºå·®å¼‚é¢„è§ˆ"
    â†’ è¿›å…¥ Default æ¨¡å¼æµç¨‹
   â†“
5b. ç”¨æˆ·é€‰æ‹© "ç›´æ¥åº”ç”¨"
    â†’ è¿›å…¥ Agent æ¨¡å¼æµç¨‹
   â†“
5c. ç”¨æˆ·é€‰æ‹© "å–æ¶ˆ"
    â†’ ä¸­æ­¢å·¥å…·æ‰§è¡Œ
```

**å…³é”®ç‰¹æ€§**ï¼š
- âš ï¸ æ¯æ¬¡ä¿®æ”¹å‰å¼¹çª—ç¡®è®¤
- âœ… ç”¨æˆ·å¯åŠ¨æ€é€‰æ‹©æ˜¯å¦é¢„è§ˆ
- âœ… å¯è®°ä½é€‰æ‹©ï¼ˆ"ä¸å†è¯¢é—®æœ¬æ¬¡ä¼šè¯"ï¼‰

**ç”¨æˆ·ä½“éªŒ**ï¼š
```
å¼¹çª—å†…å®¹ï¼š
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚ AI å³å°†ä¿®æ”¹æ–‡ä»¶                      â”‚
  â”‚                                    â”‚
  â”‚ ğŸ“ src/App.tsx (15 å¤„ä¿®æ”¹)          â”‚
  â”‚ ğŸ“ src/utils/helper.ts (3 å¤„ä¿®æ”¹)   â”‚
  â”‚                                    â”‚
  â”‚ æ‚¨å¸Œæœ›ï¼š                            â”‚
  â”‚ [ğŸ” æ˜¾ç¤ºå·®å¼‚é¢„è§ˆ] [ğŸ¤– ç›´æ¥åº”ç”¨] [âŒ å–æ¶ˆ] â”‚
  â”‚                                    â”‚
  â”‚ â˜‘ æœ¬æ¬¡ä¼šè¯è®°ä½æˆ‘çš„é€‰æ‹©              â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 2.9.5 æ¨¡å¼åˆ‡æ¢é€»è¾‘

**åˆ‡æ¢æ—¶æœº**ï¼š

1. **ä¼šè¯å¼€å§‹å‰**ï¼šç”¨æˆ·é€‰æ‹©æ¨¡å¼
2. **ä¼šè¯è¿›è¡Œä¸­**ï¼šå¯éšæ—¶åˆ‡æ¢æ¨¡å¼
3. **åˆ‡æ¢åç«‹å³ç”Ÿæ•ˆ**ï¼šä¸‹ä¸€æ¬¡ AI ä¿®æ”¹ç”Ÿæ•ˆ

**å·²æœ‰ blocks çš„å¤„ç†**ï¼š

```typescript
async onWorkModeChanged(newMode: WorkMode, oldMode: WorkMode) {
  if (newMode === 'agent' && oldMode !== 'agent') {
    // è¿›å…¥ Agentï¼ˆåŒ…æ‹¬ permissionMode=acceptEdits çš„è‡ªåŠ¨æ˜ å°„ï¼‰
    // è‡ªåŠ¨æ¥å—æ‰€æœ‰å¾…å¤„ç† blocksï¼šä¸å¼¹çª—ï¼Œä¸éœ€è¦ä»»ä½•ç¡®è®¤
    await this.acceptAllPendingBlocks();
  }
}
```

#### 2.9.6 é…ç½®é€‰é¡¹

```json
{
  // é»˜è®¤å·¥ä½œæ¨¡å¼
  "claudix.workMode.default": "default",

  // Agent æ¨¡å¼æ˜¯å¦æ˜¾ç¤ºç®€å•é€šçŸ¥
  "claudix.workMode.agent.showNotification": true,

  // Ask æ¨¡å¼æ˜¯å¦è®°ä½é€‰æ‹©
  "claudix.workMode.ask.rememberChoice": true,

  // Ask æ¨¡å¼è®°ä½é€‰æ‹©çš„æœ‰æ•ˆæœŸï¼ˆç§’ï¼‰
  "claudix.workMode.ask.rememberDuration": 3600,

  // åˆ‡æ¢æ¨¡å¼æ—¶çš„å·²æœ‰ blocks å¤„ç†ç­–ç•¥
  "claudix.workMode.switchBehavior": "acceptAll"  // 'prompt' | 'acceptAll' | 'rejectAll' | 'keep'
}
```

#### 2.9.7 ä¸ ClaudeAgentService çš„é›†æˆ

**æ¥å£å®šä¹‰**ï¼š

```typescript
// ClaudeAgentService.ts
export class ClaudeAgentService {
  private workMode: WorkMode = 'default';

  async canUseTool(
    toolName: string,
    input: Record<string, unknown>
  ): Promise<PermissionResult> {
    // æ£€æŸ¥æ˜¯å¦æ˜¯æ–‡ä»¶ä¿®æ”¹å·¥å…·
    if (toolName === 'Write' || toolName === 'Edit') {
      const filePath = input.file_path as string;

      // æ ¹æ®å·¥ä½œæ¨¡å¼å†³å®šæ˜¯å¦å¯ç”¨å·®å¼‚é¢„è§ˆ
      if (this.workMode === 'default') {
        // Default æ¨¡å¼ï¼šå¯ç”¨å·®å¼‚é¢„è§ˆ
        this.diffPreviewService.markFileForAIEdit(filePath, this.channelId);
        return { allowed: true };
      } else if (this.workMode === 'agent') {
        // Agent æ¨¡å¼ï¼šè·³è¿‡å·®å¼‚é¢„è§ˆ
        return { allowed: true };
      } else if (this.workMode === 'ask') {
        // Ask æ¨¡å¼ï¼šè¯¢é—®ç”¨æˆ·
        const choice = await this.promptUserChoice(filePath);

        if (choice === 'preview') {
          this.diffPreviewService.markFileForAIEdit(filePath, this.channelId);
        }

        return { allowed: choice !== 'cancel' };
      }
    }

    // å…¶ä»–å·¥å…·æ­£å¸¸å¤„ç†
    return super.canUseTool(toolName, input);
  }

  setWorkMode(mode: WorkMode): void {
    const oldMode = this.workMode;
    this.workMode = mode;

    // é€šçŸ¥å·®å¼‚é¢„è§ˆæœåŠ¡
    this.diffPreviewService.onWorkModeChanged(mode, oldMode);
  }
}
```

#### 2.9.8 UI é›†æˆç‚¹

**1. æ¨¡å¼é€‰æ‹©å™¨ï¼ˆChatInputBoxï¼‰**

```vue
<!-- å·²å­˜åœ¨çš„ ModeSelect ç»„ä»¶ -->
<ModeSelect
  :permission-mode="permissionMode"
  :work-mode="workMode"  <!-- æ–°å¢ -->
  @mode-select="handleModeSelect"
  @work-mode-change="handleWorkModeChange"  <!-- æ–°å¢ -->
/>
```

**2. çŠ¶æ€æ æç¤º**

```typescript
// æ ¹æ®å·¥ä½œæ¨¡å¼æ˜¾ç¤ºä¸åŒçš„çŠ¶æ€
if (workMode === 'default' && hasBlocks) {
  statusBar.text = `ğŸ“ ${blockCount} å¤„å¾…ç¡®è®¤ä¿®æ”¹`;
} else if (workMode === 'agent') {
  statusBar.text = `ğŸ¤– è‡ªåŠ¨åº”ç”¨æ¨¡å¼`;
} else if (workMode === 'ask') {
  statusBar.text = `â“ è¯¢é—®æ¨¡å¼`;
}
```

**3. è®¾ç½®é¡µé¢ï¼ˆSettingsPage.vueï¼‰**

```vue
<div class="setting-item">
  <label>é»˜è®¤å·¥ä½œæ¨¡å¼</label>
  <select v-model="defaultWorkMode">
    <option value="default">Default - å·®å¼‚é¢„è§ˆ</option>
    <option value="agent">Agent - è‡ªåŠ¨åº”ç”¨</option>
    <option value="ask">Ask - æ¯æ¬¡è¯¢é—®</option>
  </select>
  <p class="help-text">
    æ§åˆ¶ AI ä¿®æ”¹æ–‡ä»¶æ—¶çš„è¡Œä¸ºï¼š
    - Defaultï¼šæ˜¾ç¤ºçº¢ç»¿å¯¹æ¯”ï¼Œéœ€è¦ç¡®è®¤
    - Agentï¼šç›´æ¥åº”ç”¨ï¼Œæ— éœ€ç¡®è®¤
    - Askï¼šæ¯æ¬¡è¯¢é—®æ˜¯å¦é¢„è§ˆ
  </p>
</div>
```

#### 2.9.9 å…¼å®¹æ€§è¯´æ˜

**å‘åå…¼å®¹**ï¼š

- æ—§ç‰ˆæœ¬é…ç½®ï¼ˆä»…æœ‰ `permissionMode`ï¼‰ï¼š
  - `permissionMode: 'default'` â†’ æ˜ å°„ä¸º `workMode: 'default'`
  - `permissionMode: 'agent'` â†’ æ˜ å°„ä¸º `workMode: 'agent'`

**æ•°æ®è¿ç§»**ï¼š

```typescript
// æ£€æµ‹æ—§é…ç½®å¹¶è¿ç§»
async migrateOldConfig() {
  const config = vscode.workspace.getConfiguration('claudix');
  const permissionMode = config.get('permissionMode');
  const workMode = config.get('workMode');

  if (permissionMode && !workMode) {
    // æ—§ç‰ˆæœ¬é…ç½®ï¼Œè¿ç§»
    const newWorkMode = permissionMode === 'agent' ? 'agent' : 'default';
    await config.update('workMode', newWorkMode, true);

    vscode.window.showInformationMessage(
      'å·²è‡ªåŠ¨è¿ç§»é…ç½®ï¼špermissionMode â†’ workMode'
    );
  }
}
```

---

## 3. æŠ€æœ¯æ¶æ„è®¾è®¡

### 3.1 æ¨¡å—åˆ’åˆ†

```
src/services/diffPreview/
â”œâ”€â”€ DiffPreviewService.ts          # æ ¸å¿ƒæœåŠ¡ï¼ˆå¯¹å¤–æ¥å£ï¼‰
â”œâ”€â”€ state/
â”‚   â”œâ”€â”€ DiffStateManager.ts        # çŠ¶æ€ç®¡ç†å™¨
â”‚   â”œâ”€â”€ DiffBlock.ts               # Block æ•°æ®æ¨¡å‹
â”‚   â””â”€â”€ FileState.ts               # æ–‡ä»¶çŠ¶æ€æ¨¡å‹
â”œâ”€â”€ diff/
â”‚   â”œâ”€â”€ DiffCalculator.ts          # Diff è®¡ç®—å¼•æ“
â”‚   â”œâ”€â”€ MyersDiff.ts               # Myers ç®—æ³•å®ç°
â”‚   â””â”€â”€ IncrementalDiff.ts         # å¢é‡ Diff
â”œâ”€â”€ marker/
â”‚   â”œâ”€â”€ MarkerInserter.ts          # Marker æ’å…¥é€»è¾‘
â”‚   â”œâ”€â”€ MarkerParser.ts            # Marker è§£æé€»è¾‘
â”‚   â””â”€â”€ MarkerValidator.ts         # Marker æ ¡éªŒé€»è¾‘
â”œâ”€â”€ ui/
â”‚   â”œâ”€â”€ DecorationManager.ts       # è£…é¥°å™¨ç®¡ç†
â”‚   â”œâ”€â”€ CodeLensProvider.ts        # CodeLens æä¾›è€…
â”‚   â””â”€â”€ VirtualScrollManager.ts    # è™šæ‹Ÿæ»šåŠ¨ä¼˜åŒ–
â”œâ”€â”€ persistence/
â”‚   â”œâ”€â”€ StateSerializer.ts         # çŠ¶æ€åºåˆ—åŒ–
â”‚   â””â”€â”€ StateRestorer.ts           # çŠ¶æ€æ¢å¤
â””â”€â”€ utils/
    â”œâ”€â”€ BlockIdGenerator.ts        # Block ID ç”Ÿæˆ
    â”œâ”€â”€ FileWatcher.ts             # æ–‡ä»¶ç›‘å¬åŒ…è£…
    â””â”€â”€ PerformanceMonitor.ts      # æ€§èƒ½ç›‘æ§
```

### 3.2 æ ¸å¿ƒæ¥å£å®šä¹‰

#### 3.2.1 DiffPreviewServiceï¼ˆä¸»æœåŠ¡ï¼‰

```typescript
export interface IDiffPreviewService {
  /**
   * æ ‡è®°æ–‡ä»¶å³å°†è¢« AI ä¿®æ”¹
   */
  markFileForAIEdit(filePath: string, channelId: string): void;

  /**
   * å¤„ç† AI ä¿®æ”¹ï¼ˆæ ¸å¿ƒå…¥å£ï¼‰
   */
  handleAIEdit(filePath: string, oldContent: string, newContent: string): Promise<void>;

  /**
   * æ¥å—å•ä¸ª block
   */
  acceptBlock(blockId: string): Promise<void>;

  /**
   * æ‹’ç»å•ä¸ª block
   */
  rejectBlock(blockId: string): Promise<void>;

  /**
   * æ¥å—æ–‡ä»¶çš„æ‰€æœ‰ blocks
   */
  acceptAllBlocks(filePath: string): Promise<void>;

  /**
   * æ‹’ç»æ–‡ä»¶çš„æ‰€æœ‰ blocks
   */
  rejectAllBlocks(filePath: string): Promise<void>;

  /**
   * è·å–æ–‡ä»¶çš„æ‰€æœ‰ blocks
   */
  getBlocks(filePath: string): DiffBlock[];

  /**
   * æ¸…ç©ºæ–‡ä»¶çš„æ‰€æœ‰ blocks
   */
  clearBlocks(filePath: string): Promise<void>;

  /**
   * å¯ç”¨/ç¦ç”¨å·®å¼‚é¢„è§ˆåŠŸèƒ½
   */
  setEnabled(enabled: boolean): void;

  /**
   * è·å–ç»Ÿè®¡ä¿¡æ¯
   */
  getStats(): DiffStats;
}
```

#### 3.2.2 DiffBlockï¼ˆæ•°æ®æ¨¡å‹ï¼‰

```typescript
export interface DiffBlock {
  // å”¯ä¸€æ ‡è¯†
  id: string;

  // æ–‡ä»¶ä¿¡æ¯
  filePath: string;

  // ä½ç½®ä¿¡æ¯ï¼ˆåŸºäºå½“å‰æ–‡æ¡£çš„è¡Œå·ï¼‰
  startLine: number;          // <<<<<<< æ‰€åœ¨è¡Œ
  separatorLine: number;      // ======= æ‰€åœ¨è¡Œ
  endLine: number;            // >>>>>>> æ‰€åœ¨è¡Œ

  // å†…å®¹å¿«ç…§
  baseContent: string;        // åŸºå‡†å†…å®¹ï¼ˆåŸå§‹æˆ–ä¸Šæ¬¡æ¥å—çš„ï¼‰
  currentContent: string;     // å½“å‰ä¿®æ”¹å†…å®¹

  // åŸºå‡†ç±»å‹
  baseType: 'original' | 'accepted';
  baseBlockId?: string;       // å¦‚æœåŸºå‡†æ˜¯æ¥å—åçš„ï¼Œè®°å½•é‚£ä¸ª block çš„ ID

  // çŠ¶æ€
  status: 'pending' | 'accepted' | 'rejected' | 'invalidated';

  // æ—¶é—´æˆ³
  createdAt: number;
  lastModified: number;
  processedAt?: number;       // æ¥å—æˆ–æ‹’ç»çš„æ—¶é—´

  // å…ƒæ•°æ®
  changeType: 'add' | 'delete' | 'modify';  // å˜æ›´ç±»å‹
  linesAdded: number;
  linesDeleted: number;

  // AI ä¿¡æ¯
  aiChannelId?: string;       // å…³è”çš„ AI channel
  aiToolName?: string;        // ä½¿ç”¨çš„å·¥å…·åï¼ˆWrite/Editï¼‰
}
```

#### 3.2.3 FileStateï¼ˆæ–‡ä»¶çŠ¶æ€ï¼‰

```typescript
export interface FileState {
  filePath: string;

  // å†…å®¹å¿«ç…§
  originalContent: string;       // åˆå§‹çŠ¶æ€ï¼ˆç¬¬ä¸€æ¬¡ AI ä¿®æ”¹å‰ï¼‰
  currentDiskContent: string;    // ç£ç›˜ä¸Šçš„æœ€æ–°å†…å®¹

  // Blocks ç®¡ç†
  blocks: Map<string, DiffBlock>;
  blockOrder: string[];          // Block çš„é¡ºåºï¼ˆä»ä¸Šåˆ°ä¸‹ï¼‰

  // çŠ¶æ€è¿½è¸ª
  isMarkedForAIEdit: boolean;
  markedChannelId?: string;
  lastAIEditTime: number;

  // ç»Ÿè®¡ä¿¡æ¯
  totalBlocksCreated: number;
  totalBlocksAccepted: number;
  totalBlocksRejected: number;

  // æ–‡ä»¶å“ˆå¸Œï¼ˆç”¨äºæ£€æµ‹å¤–éƒ¨ä¿®æ”¹ï¼‰
  contentHash: string;

  // åŒæ­¥æ—¶é—´
  lastSyncTime: number;
}
```

#### 3.2.4 DiffCalculatorï¼ˆDiff å¼•æ“ï¼‰

```typescript
export interface IDiffCalculator {
  /**
   * è®¡ç®—ä¸¤ä¸ªå†…å®¹çš„å·®å¼‚
   */
  calculate(
    oldContent: string,
    newContent: string,
    options?: DiffOptions
  ): DiffResult;

  /**
   * å¢é‡è®¡ç®—ï¼ˆä»…è®¡ç®—å˜åŒ–èŒƒå›´ï¼‰
   */
  calculateIncremental(
    oldContent: string,
    newContent: string,
    changedRanges: vscode.Range[]
  ): DiffResult;
}

export interface DiffOptions {
  algorithm: 'myers' | 'simple';     // Diff ç®—æ³•
  maxBlockSize: number;              // å•ä¸ª block æœ€å¤§è¡Œæ•°
  ignoreWhitespace: boolean;         // æ˜¯å¦å¿½ç•¥ç©ºç™½
  contextLines: number;              // ä¸Šä¸‹æ–‡è¡Œæ•°ï¼ˆé»˜è®¤ 0ï¼‰
}

export interface DiffResult {
  blocks: DiffBlockData[];
  stats: {
    totalLines: number;
    addedLines: number;
    deletedLines: number;
    modifiedLines: number;
  };
  performance: {
    duration: number;
    algorithm: string;
  };
}

export interface DiffBlockData {
  startLine: number;
  endLine: number;
  deletedLines: string[];
  addedLines: string[];
  changeType: 'add' | 'delete' | 'modify';
}
```

### 3.3 å·¥ä½œæµç¨‹å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     AI ä¿®æ”¹æ–‡ä»¶æµç¨‹                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

1. ClaudeAgentService.canUseTool('Write' | 'Edit')
   â†“
2. DiffPreviewService.markFileForAIEdit(filePath, channelId)
   â†“ ï¼ˆæ ‡è®°ï¼š30ç§’å†…çš„æ–‡ä»¶ä¿®æ”¹è§†ä¸º AI ä¿®æ”¹ï¼‰
3. SDK æ‰§è¡Œå·¥å…·ï¼Œæ–‡ä»¶è¢«çœŸå®ä¿®æ”¹
   â†“
4. vscode.workspace.onDidChangeTextDocument è§¦å‘
   â†“
5. æ£€æµ‹åˆ°æ˜¯ AI ä¿®æ”¹ (isMarkedForAIEdit = true)
   â†“
6. DiffPreviewService.handleAIEdit(filePath, oldContent, newContent)
   â”œâ”€ a. DiffCalculator.calculate(oldContent, newContent)
   â”‚     â†’ è¿”å› DiffResult
   â”œâ”€ b. DiffStateManager.processNewDiff(filePath, diffResult)
   â”‚     â†’ åˆ›å»º/æ›´æ–° DiffBlocks
   â”‚     â†’ å¤„ç†åŒä½ç½®å¤šæ¬¡ä¿®æ”¹ï¼ˆæ›´æ–°åŸºå‡†ï¼‰
   â”œâ”€ c. MarkerInserter.insertMarkers(filePath, blocks)
   â”‚     â†’ æ„å»ºå¸¦ conflict markers çš„å†…å®¹
   â”‚     â†’ ä½¿ç”¨ WorkspaceEdit æ›¿æ¢æ–‡æ¡£
   â”œâ”€ d. DecorationManager.applyDecorations(filePath, blocks)
   â”‚     â†’ è®¾ç½®çº¢ç»¿è£…é¥°å™¨
   â”œâ”€ e. CodeLensProvider.refresh()
   â”‚     â†’ æ˜¾ç¤ºæ¥å—/æ‹’ç»æŒ‰é’®
   â””â”€ f. StateSerializer.saveState()
         â†’ æŒä¹…åŒ–çŠ¶æ€


â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   ç”¨æˆ·æ¥å— Block æµç¨‹                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

1. ç”¨æˆ·ç‚¹å‡» [âœ… æ¥å—] æˆ–æŒ‰ä¸‹ Cmd+K
   â†“
2. DiffPreviewService.acceptBlock(blockId)
   â”œâ”€ a. DiffStateManager.updateBlockStatus(blockId, 'accepted')
   â”‚     â†’ æ›´æ–° block.status = 'accepted'
   â”‚     â†’ è®°å½• block.processedAt = Date.now()
   â”œâ”€ b. MarkerInserter.removeMarkers(blockId)
   â”‚     â†’ åˆ é™¤è¯¥ block çš„ conflict markers
   â”‚     â†’ ä¿ç•™æ–°å†…å®¹ï¼ˆç»¿è‰²éƒ¨åˆ†ï¼‰
   â”œâ”€ c. DecorationManager.removeDecorations(blockId)
   â”‚     â†’ ç§»é™¤çº¢ç»¿è£…é¥°å™¨
   â”‚     â†’ å¯é€‰ï¼šçŸ­æš‚æ˜¾ç¤º"æ¥å—æˆåŠŸ"åŠ¨ç”»
   â”œâ”€ d. æ›´æ–°åŸºå‡†çŠ¶æ€
   â”‚     â†’ fileState.baseContent[ä½ç½®] = block.currentContent
   â”‚     â†’ fileState.baseType[ä½ç½®] = 'accepted'
   â”œâ”€ e. CodeLensProvider.refresh()
   â”‚     â†’ æ›´æ–°è®¡æ•°å™¨ï¼ˆå¦‚ [1/5] â†’ [1/4]ï¼‰
   â”œâ”€ f. StateSerializer.saveState()
   â”‚     â†’ æŒä¹…åŒ–çŠ¶æ€
   â””â”€ g. æ™ºèƒ½è·³è½¬
         â†’ å…‰æ ‡è·³åˆ°ä¸‹ä¸€ä¸ªæœªå¤„ç†çš„ block


â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   ç”¨æˆ·æ‹’ç» Block æµç¨‹                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

1. ç”¨æˆ·ç‚¹å‡» [âŒ æ‹’ç»] æˆ–æŒ‰ä¸‹ Cmd+Shift+K
   â†“
2. DiffPreviewService.rejectBlock(blockId)
   â”œâ”€ a. DiffStateManager.updateBlockStatus(blockId, 'rejected')
   â”œâ”€ b. MarkerInserter.removeMarkers(blockId)
   â”‚     â†’ åˆ é™¤ conflict markers
   â”‚     â†’ ä¿ç•™æ—§å†…å®¹ï¼ˆçº¢è‰²éƒ¨åˆ†ï¼‰
   â”œâ”€ c. å›æ»šç£ç›˜æ–‡ä»¶
   â”‚     â†’ const contentToRestore = block.baseContent
   â”‚     â†’ WorkspaceEdit æ›¿æ¢è¯¥èŒƒå›´çš„å†…å®¹
   â”œâ”€ d. DecorationManager.removeDecorations(blockId)
   â”œâ”€ e. CodeLensProvider.refresh()
   â””â”€ f. StateSerializer.saveState()


â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   åŒä½ç½®å¤šæ¬¡ä¿®æ”¹å¤„ç†                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

åˆå§‹çŠ¶æ€ï¼š
  const x = 1;

AI ä¿®æ”¹ 1ï¼ˆåˆ›å»º block-Aï¼‰ï¼š
  const x = 2;
  â†’ baseContent = "const x = 1;"
  â†’ currentContent = "const x = 2;"
  â†’ baseType = 'original'

ç”¨æˆ·æ¥å— block-Aï¼š
  â†’ æ›´æ–°åŸºå‡†ï¼š
    baseContent[ä½ç½®] = "const x = 2;"
    baseType[ä½ç½®] = 'accepted'
    baseBlockId[ä½ç½®] = 'block-A'

AI ä¿®æ”¹ 2ï¼ˆåŒä½ç½®ï¼Œåˆ›å»º block-Bï¼‰ï¼š
  const x = 3;
  â†’ æ£€æµ‹åˆ°è¯¥ä½ç½®æœ‰åŸºå‡†çŠ¶æ€
  â†’ baseContent = "const x = 2;"  ï¼ˆæ¥è‡ª block-Aï¼‰
  â†’ currentContent = "const x = 3;"
  â†’ baseType = 'accepted'
  â†’ baseBlockId = 'block-A'

  â†’ Marker æ˜¾ç¤ºï¼š
    <<<<<<< Original [block-B]
    const x = 2;  // çº¢è‰²ï¼ˆæ¥è‡ªä¸Šæ¬¡æ¥å—çš„çŠ¶æ€ï¼‰
    =======
    const x = 3;  // ç»¿è‰²
    >>>>>>> Claude's Change
```

---

## 4. æ•°æ®æµè®¾è®¡

### 4.1 çŠ¶æ€ç®¡ç†æ¶æ„

```
å…¨å±€å•ä¾‹ï¼šDiffStateManager
  â†“
Map<filePath, FileState>
  â†“
FileState {
  blocks: Map<blockId, DiffBlock>
  originalContent: string
  ...
}
```

### 4.2 äº‹ä»¶é©±åŠ¨æµ

```typescript
// æ ¸å¿ƒäº‹ä»¶
export type DiffPreviewEvent =
  | { type: 'block_created', blockId: string, filePath: string }
  | { type: 'block_accepted', blockId: string, filePath: string }
  | { type: 'block_rejected', blockId: string, filePath: string }
  | { type: 'block_invalidated', blockId: string, reason: string }
  | { type: 'all_blocks_cleared', filePath: string }
  | { type: 'state_restored', fileCount: number };

// äº‹ä»¶æ€»çº¿
export class DiffEventBus {
  private emitter = new vscode.EventEmitter<DiffPreviewEvent>();

  readonly onEvent = this.emitter.event;

  emit(event: DiffPreviewEvent) {
    this.emitter.fire(event);
  }
}

// è®¢é˜…ç¤ºä¾‹
diffEventBus.onEvent(event => {
  switch (event.type) {
    case 'block_accepted':
      // æ›´æ–°ç»Ÿè®¡
      // å‘é€é¥æµ‹
      // æ˜¾ç¤ºé€šçŸ¥
      break;
  }
});
```

### 4.3 ç¼“å­˜ç­–ç•¥

```typescript
class DiffStateCache {
  // L1 ç¼“å­˜ï¼šæ´»è·ƒæ–‡ä»¶çš„å®Œæ•´çŠ¶æ€ï¼ˆå†…å­˜ï¼‰
  private activeFiles = new Map<string, FileState>();

  // L2 ç¼“å­˜ï¼šéæ´»è·ƒæ–‡ä»¶çš„å…ƒæ•°æ®ï¼ˆå†…å­˜ï¼‰
  private inactiveFiles = new Map<string, FileMetadata>();

  // L3 ç¼“å­˜ï¼šæŒä¹…åŒ–å­˜å‚¨ï¼ˆç£ç›˜ï¼‰
  private disk: StateSerializer;

  // ç¼“å­˜ç­–ç•¥
  async get(filePath: string): Promise<FileState> {
    // 1. æŸ¥ L1
    if (this.activeFiles.has(filePath)) {
      return this.activeFiles.get(filePath);
    }

    // 2. æŸ¥ L2ï¼Œä»ç£ç›˜åŠ è½½å®Œæ•´çŠ¶æ€
    if (this.inactiveFiles.has(filePath)) {
      const state = await this.disk.loadFile(filePath);
      this.activeFiles.set(filePath, state);
      return state;
    }

    // 3. ä¸å­˜åœ¨ï¼Œè¿”å›ç©ºçŠ¶æ€
    return this.createEmptyState(filePath);
  }

  // LRU æ·˜æ±°ç­–ç•¥
  evictLRU() {
    if (this.activeFiles.size > 10) {  // æœ€å¤šç¼“å­˜ 10 ä¸ªæ–‡ä»¶
      const oldest = this.findOldestFile();
      this.moveToL2(oldest);
    }
  }
}
```

---

## 5. ç”¨æˆ·ç•Œé¢è®¾è®¡

### 5.1 ç¼–è¾‘å™¨å†…æ˜¾ç¤º

#### ç¤ºä¾‹ 1ï¼šå•ä¸ª Block

```typescript
// æ–‡ä»¶ï¼šsrc/App.tsx
10: import React from 'react';
11:
12: [1/3] âœ… æ¥å—  âŒ æ‹’ç»  ğŸ“‹ è¯¦æƒ…
13: <<<<<<< Original [block-abc]
14: - function App() {
15: -   return <div>Hello</div>;
16: - }
17: =======
18: + function App(): JSX.Element {
19: +   return <div>Hello World</div>;
20: + }
21: >>>>>>> Claude's Change
22:
23: export default App;
```

**è§†è§‰æ•ˆæœ**ï¼š
- ç¬¬ 14-16 è¡Œï¼šçº¢è‰²èƒŒæ™¯ + å·¦ä¾§ "-" ç¬¦å·
- ç¬¬ 18-20 è¡Œï¼šç»¿è‰²èƒŒæ™¯ + å·¦ä¾§ "+" ç¬¦å·
- ç¬¬ 13ã€17ã€21 è¡Œï¼šç°è‰²åŠé€æ˜èƒŒæ™¯
- ç¬¬ 12 è¡Œï¼šCodeLens æŒ‰é’®ï¼ˆæ‚¬æµ®åœ¨ä»£ç ä¸Šæ–¹ï¼‰

#### ç¤ºä¾‹ 2ï¼šå¤šä¸ª Blocks

```typescript
// æ–‡ä»¶é¡¶éƒ¨æ˜¾ç¤ºå…¨å±€æŒ‰é’®
[æ–‡ä»¶æœ‰ 3 å¤„å¾…ç¡®è®¤çš„ä¿®æ”¹] ğŸ”„ å…¨éƒ¨æ¥å—  ğŸš« å…¨éƒ¨æ‹’ç»  ğŸ“Š ç»Ÿè®¡

1: import React from 'react';
2:
3: [1/3] âœ… æ¥å—  âŒ æ‹’ç»
4: <<<<<<< Original [block-abc]
...
10: >>>>>>> Claude's Change
11:
12: [2/3] âœ… æ¥å—  âŒ æ‹’ç»
13: <<<<<<< Original [block-def]
...
```

### 5.2 çŠ¶æ€æ æç¤º

```
# æ–‡ä»¶æœ‰æœªå¤„ç†çš„ blocks
[Claudix] ğŸ“ 3 å¤„å¾…ç¡®è®¤ä¿®æ”¹ | [ä¸‹ä¸€ä¸ª Cmd+]] [æ¥å— Cmd+K]

# æ­£åœ¨å¤„ç†
[Claudix] âš™ï¸ æ­£åœ¨è®¡ç®—å·®å¼‚...

# å…¨éƒ¨å¤„ç†å®Œæˆ
[Claudix] âœ… æ‰€æœ‰ä¿®æ”¹å·²å¤„ç†
```

### 5.3 ä¾§è¾¹æ é¢æ¿ï¼ˆå¯é€‰ï¼‰

**ä½ç½®**ï¼šActivity Bar æ–°å¢ "Diff Preview" å›¾æ ‡

**å†…å®¹**ï¼š

```
Diff Preview
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

ğŸ“ src/App.tsx (3 å¤„ä¿®æ”¹)
  â”œâ”€ [1] ç¬¬ 12 è¡Œï¼šæ·»åŠ ç±»å‹æ³¨è§£
  â”‚    âœ… æ¥å—  âŒ æ‹’ç»
  â”œâ”€ [2] ç¬¬ 45 è¡Œï¼šä¿®å¤æ‹¼å†™é”™è¯¯
  â”‚    âœ… æ¥å—  âŒ æ‹’ç»
  â””â”€ [3] ç¬¬ 89 è¡Œï¼šä¼˜åŒ–æ€§èƒ½
       âœ… æ¥å—  âŒ æ‹’ç»

ğŸ“ src/utils/helper.ts (1 å¤„ä¿®æ”¹)
  â””â”€ [1] ç¬¬ 5 è¡Œï¼šæ·»åŠ é”™è¯¯å¤„ç†
       âœ… æ¥å—  âŒ æ‹’ç»

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
å…¨å±€æ“ä½œï¼š
  [æ¥å—æ‰€æœ‰] [æ‹’ç»æ‰€æœ‰] [æ¸…ç©º]
```

### 5.4 å¿«é€Ÿé¢æ¿ï¼ˆCmd+Shift+Pï¼‰

```
> Claudix: æ¥å—å½“å‰å—
> Claudix: æ‹’ç»å½“å‰å—
> Claudix: æ¥å—æ‰€æœ‰ä¿®æ”¹
> Claudix: æ‹’ç»æ‰€æœ‰ä¿®æ”¹
> Claudix: è·³åˆ°ä¸‹ä¸€ä¸ªå·®å¼‚å—
> Claudix: è·³åˆ°ä¸Šä¸€ä¸ªå·®å¼‚å—
> Claudix: æ¸…ç©ºæ‰€æœ‰å·®å¼‚å—
> Claudix: æ˜¾ç¤ºå·®å¼‚ç»Ÿè®¡
> Claudix: åˆ‡æ¢å·®å¼‚é¢„è§ˆæ¨¡å¼
> Claudix: å¯¼å‡ºå·®å¼‚æŠ¥å‘Š
```

---

## 6. é…ç½®é€‰é¡¹

### 6.1 ç”¨æˆ·é…ç½®ï¼ˆsettings.jsonï¼‰

```json
{
  "claudix.diffPreview.enabled": true,
  "claudix.diffPreview.autoSave": false,
  "claudix.diffPreview.maxBlocksPerFile": 50,
  "claudix.diffPreview.diffAlgorithm": "myers",
  "claudix.diffPreview.showLineNumbers": true,
  "claudix.diffPreview.colorScheme": {
    "added": "rgba(0, 255, 0, 0.2)",
    "deleted": "rgba(255, 0, 0, 0.2)",
    "marker": "rgba(128, 128, 128, 0.15)"
  },
  "claudix.diffPreview.codeLens.enabled": true,
  "claudix.diffPreview.codeLens.showCount": true,
  "claudix.diffPreview.persistence.enabled": true,
  "claudix.diffPreview.persistence.location": ".vscode/claudix-diff-state.json",
  "claudix.diffPreview.performance.virtualScroll": true,
  "claudix.diffPreview.performance.maxFileSize": 10000,
  "claudix.diffPreview.notifications.onAccept": false,
  "claudix.diffPreview.notifications.onReject": true,
  "claudix.diffPreview.shortcuts.accept": "cmd+k",
  "claudix.diffPreview.shortcuts.reject": "cmd+shift+k"
}
```

### 6.2 å·¥ä½œæ¨¡å¼é›†æˆ

#### 6.2.1 åŸºç¡€é…ç½®

```json
{
  // é»˜è®¤å·¥ä½œæ¨¡å¼
  "claudix.workMode": "default",  // 'default' | 'agent' | 'ask'

  // å·¥ä½œæ¨¡å¼è¡Œä¸ºè¯´æ˜ï¼š
  // - 'default': å¯ç”¨å·®å¼‚é¢„è§ˆï¼Œæ˜¾ç¤º conflict markersï¼Œéœ€è¦ç”¨æˆ·é€ä¸€ç¡®è®¤
  // - 'agent': ç¦ç”¨å·®å¼‚é¢„è§ˆï¼ŒAI ä¿®æ”¹ç›´æ¥åº”ç”¨ï¼Œæ— éœ€ç”¨æˆ·ç¡®è®¤
  // - 'ask': æ¯æ¬¡ä¿®æ”¹å‰å¼¹çª—è¯¢é—®ç”¨æˆ·é€‰æ‹©é¢„è§ˆæˆ–ç›´æ¥åº”ç”¨
}
```

#### 6.2.2 Default æ¨¡å¼é…ç½®

```json
{
  // Default æ¨¡å¼ï¼šå·®å¼‚é¢„è§ˆçš„è¯¦ç»†é…ç½®
  "claudix.workMode.default.enabled": true,

  // æ˜¯å¦åœ¨æ¥å—ä¿®æ”¹åæ˜¾ç¤ºæˆåŠŸåŠ¨ç”»
  "claudix.workMode.default.showAcceptAnimation": true,

  // æ¥å—ä¿®æ”¹åçš„åŠ¨ç”»æŒç»­æ—¶é—´ï¼ˆæ¯«ç§’ï¼‰
  "claudix.workMode.default.animationDuration": 500,

  // æ˜¯å¦åœ¨çŠ¶æ€æ æ˜¾ç¤ºå¾…å¤„ç†å—çš„æ•°é‡
  "claudix.workMode.default.showPendingCount": true,

  // æ˜¯å¦è‡ªåŠ¨è·³è½¬åˆ°ç¬¬ä¸€ä¸ªå·®å¼‚å—
  "claudix.workMode.default.autoFocusFirstBlock": true
}
```

#### 6.2.3 Agent æ¨¡å¼é…ç½®

```json
{
  // Agent æ¨¡å¼ï¼šè‡ªåŠ¨åº”ç”¨çš„è¯¦ç»†é…ç½®
  "claudix.workMode.agent.enabled": true,

  // æ˜¯å¦æ˜¾ç¤º"å·²è‡ªåŠ¨åº”ç”¨ä¿®æ”¹"çš„é€šçŸ¥
  "claudix.workMode.agent.showNotification": true,

  // é€šçŸ¥æ˜¾ç¤ºæ—¶é•¿ï¼ˆæ¯«ç§’ï¼Œ0 è¡¨ç¤ºä¸è‡ªåŠ¨å…³é—­ï¼‰
  "claudix.workMode.agent.notificationDuration": 3000,

  // é€šçŸ¥ç±»å‹
  "claudix.workMode.agent.notificationType": "statusBar",  // 'statusBar' | 'toast' | 'none'

  // æ˜¯å¦è®°å½•è‡ªåŠ¨åº”ç”¨çš„æ—¥å¿—
  "claudix.workMode.agent.logChanges": true
}
```

#### 6.2.4 Ask æ¨¡å¼é…ç½®

```json
{
  // Ask æ¨¡å¼ï¼šè¯¢é—®è¡Œä¸ºçš„è¯¦ç»†é…ç½®
  "claudix.workMode.ask.enabled": true,

  // æ˜¯å¦å…è®¸ç”¨æˆ·å‹¾é€‰"è®°ä½æˆ‘çš„é€‰æ‹©"
  "claudix.workMode.ask.allowRememberChoice": true,

  // è®°ä½é€‰æ‹©çš„æœ‰æ•ˆæœŸï¼ˆç§’ï¼Œ-1 è¡¨ç¤ºæ°¸ä¹…ï¼‰
  "claudix.workMode.ask.rememberDuration": 3600,

  // å¼¹çª—æ˜¾ç¤ºçš„è¯¦ç»†ç¨‹åº¦
  "claudix.workMode.ask.detailLevel": "summary",  // 'minimal' | 'summary' | 'detailed'

  // minimal: ä»…æ˜¾ç¤ºæ–‡ä»¶æ•°é‡
  // summary: æ˜¾ç¤ºæ–‡ä»¶åå’Œä¿®æ”¹æ•°é‡ï¼ˆé»˜è®¤ï¼‰
  // detailed: æ˜¾ç¤ºå®Œæ•´çš„ä¿®æ”¹é¢„è§ˆ
}
```

#### 6.2.5 æ¨¡å¼åˆ‡æ¢é…ç½®

```json
{
  // åˆ‡æ¢å·¥ä½œæ¨¡å¼æ—¶ï¼Œå¯¹å·²æœ‰å·®å¼‚å—çš„å¤„ç†ç­–ç•¥
  "claudix.workMode.switchBehavior": "prompt",
  // å¯é€‰å€¼ï¼š
  // - 'prompt': å¼¹çª—è¯¢é—®ç”¨æˆ·ï¼ˆé»˜è®¤ï¼‰
  // - 'acceptAll': è‡ªåŠ¨æ¥å—æ‰€æœ‰æœªå¤„ç†çš„å—
  // - 'rejectAll': è‡ªåŠ¨æ‹’ç»æ‰€æœ‰æœªå¤„ç†çš„å—
  // - 'keep': ä¿ç•™æ‰€æœ‰å—ï¼Œä¸åšå¤„ç†

  // åˆ‡æ¢æ¨¡å¼æ—¶æ˜¯å¦æ˜¾ç¤ºç¡®è®¤æç¤º
  "claudix.workMode.switchConfirmation": true,

  // å¿«é€Ÿåˆ‡æ¢å·¥ä½œæ¨¡å¼çš„å¿«æ·é”®ï¼ˆCmd+Option+Mï¼‰
  "claudix.workMode.quickSwitch.enabled": true
}
```

#### 6.2.6 ä¸å·®å¼‚é¢„è§ˆåŠŸèƒ½çš„è”åŠ¨

```json
{
  // å½“ workMode = 'default' æ—¶ï¼Œä»¥ä¸‹å·®å¼‚é¢„è§ˆé…ç½®æ‰ä¼šç”Ÿæ•ˆï¼š
  "claudix.diffPreview.enabled": true,
  "claudix.diffPreview.maxBlocksPerFile": 50,
  "claudix.diffPreview.diffAlgorithm": "myers",
  // ... å…¶ä»–å·®å¼‚é¢„è§ˆé…ç½®ï¼ˆè§ 6.1 èŠ‚ï¼‰

  // å½“ workMode = 'agent' æ—¶ï¼Œå·®å¼‚é¢„è§ˆåŠŸèƒ½è‡ªåŠ¨ç¦ç”¨
  // å½“ workMode = 'ask' æ—¶ï¼Œæ ¹æ®ç”¨æˆ·é€‰æ‹©åŠ¨æ€å¯ç”¨/ç¦ç”¨
}
```

#### 6.2.7 å®Œæ•´é…ç½®ç¤ºä¾‹

```json
{
  // === å·¥ä½œæ¨¡å¼åŸºç¡€é…ç½® ===
  "claudix.workMode": "default",

  // === Default æ¨¡å¼é…ç½® ===
  "claudix.workMode.default.enabled": true,
  "claudix.workMode.default.showAcceptAnimation": true,
  "claudix.workMode.default.animationDuration": 500,
  "claudix.workMode.default.showPendingCount": true,
  "claudix.workMode.default.autoFocusFirstBlock": true,

  // === Agent æ¨¡å¼é…ç½® ===
  "claudix.workMode.agent.enabled": true,
  "claudix.workMode.agent.showNotification": true,
  "claudix.workMode.agent.notificationDuration": 3000,
  "claudix.workMode.agent.notificationType": "statusBar",
  "claudix.workMode.agent.logChanges": true,

  // === Ask æ¨¡å¼é…ç½® ===
  "claudix.workMode.ask.enabled": true,
  "claudix.workMode.ask.allowRememberChoice": true,
  "claudix.workMode.ask.rememberDuration": 3600,
  "claudix.workMode.ask.detailLevel": "summary",

  // === æ¨¡å¼åˆ‡æ¢é…ç½® ===
  "claudix.workMode.switchBehavior": "prompt",
  "claudix.workMode.switchConfirmation": true,
  "claudix.workMode.quickSwitch.enabled": true,

  // === å·®å¼‚é¢„è§ˆé…ç½®ï¼ˆä»…åœ¨ default æ¨¡å¼ç”Ÿæ•ˆï¼‰===
  "claudix.diffPreview.enabled": true,
  "claudix.diffPreview.maxBlocksPerFile": 50,
  "claudix.diffPreview.diffAlgorithm": "myers",
  "claudix.diffPreview.colorScheme": {
    "added": "rgba(0, 255, 0, 0.2)",
    "deleted": "rgba(255, 0, 0, 0.2)",
    "marker": "rgba(128, 128, 128, 0.15)"
  }
}
```

#### 6.2.8 æ¨èé…ç½®åœºæ™¯

**åœºæ™¯ 1ï¼šè°¨æ…å¼€å‘è€…ï¼ˆæ¨èæ–°æ‰‹ï¼‰**

```json
{
  "claudix.workMode": "default",
  "claudix.workMode.default.autoFocusFirstBlock": true,
  "claudix.diffPreview.maxBlocksPerFile": 30,
  "claudix.diffPreview.notifications.onAccept": true,
  "claudix.diffPreview.notifications.onReject": true
}
```

**åœºæ™¯ 2ï¼šé«˜æ•ˆå¼€å‘è€…ï¼ˆæ¨èç†Ÿç»ƒç”¨æˆ·ï¼‰**

```json
{
  "claudix.workMode": "ask",
  "claudix.workMode.ask.allowRememberChoice": true,
  "claudix.workMode.ask.rememberDuration": 7200,
  "claudix.workMode.quickSwitch.enabled": true,
  "claudix.diffPreview.shortcuts.accept": "cmd+k"
}
```

**åœºæ™¯ 3ï¼šä¿¡ä»» AIï¼ˆæ¨èç´§æ€¥æƒ…å†µï¼‰**

```json
{
  "claudix.workMode": "agent",
  "claudix.workMode.agent.showNotification": true,
  "claudix.workMode.agent.logChanges": true,
  "claudix.workMode.switchBehavior": "keep"
}
```

---

## 7. æ€§èƒ½æŒ‡æ ‡è¦æ±‚

### 7.1 å“åº”æ—¶é—´

| æ“ä½œ | ç›®æ ‡æ—¶é—´ | æœ€å¤§å®¹å¿æ—¶é—´ |
|-----|---------|------------|
| Diff è®¡ç®—ï¼ˆ<1000 è¡Œï¼‰ | < 100ms | < 300ms |
| Diff è®¡ç®—ï¼ˆ1000-5000 è¡Œï¼‰ | < 500ms | < 1s |
| Diff è®¡ç®—ï¼ˆ>5000 è¡Œï¼‰ | < 2s | < 5s |
| æ’å…¥ Markers | < 50ms | < 200ms |
| æ¥å—/æ‹’ç»æ“ä½œ | < 50ms | < 100ms |
| è£…é¥°å™¨æ¸²æŸ“ | < 30ms | < 100ms |
| CodeLens æ›´æ–° | < 50ms | < 150ms |

### 7.2 å†…å­˜å ç”¨

| åœºæ™¯ | ç›®æ ‡ | æœ€å¤§å®¹å¿ |
|-----|------|---------|
| å•æ–‡ä»¶çŠ¶æ€ï¼ˆ1000 è¡Œï¼‰ | < 500KB | < 1MB |
| 10 ä¸ªæ–‡ä»¶ç¼“å­˜ | < 10MB | < 20MB |
| æŒä¹…åŒ–æ–‡ä»¶å¤§å° | < 1MB | < 5MB |

### 7.3 æ€§èƒ½ç›‘æ§

```typescript
class PerformanceMonitor {
  private metrics: Map<string, PerformanceEntry[]> = new Map();

  measure<T>(operation: string, fn: () => T): T {
    const start = performance.now();
    try {
      return fn();
    } finally {
      const duration = performance.now() - start;
      this.record(operation, duration);

      // è­¦å‘Šæ…¢æ“ä½œ
      if (duration > SLOW_THRESHOLD[operation]) {
        console.warn(`[Performance] ${operation} took ${duration}ms (expected < ${SLOW_THRESHOLD[operation]}ms)`);
      }
    }
  }

  getReport(): PerformanceReport {
    // ç”Ÿæˆæ€§èƒ½æŠ¥å‘Š
  }
}
```

---

## 8. æµ‹è¯•è¦æ±‚

### 8.1 å•å…ƒæµ‹è¯•è¦†ç›–ç‡

| æ¨¡å— | ç›®æ ‡è¦†ç›–ç‡ |
|-----|----------|
| DiffCalculator | 95% |
| DiffStateManager | 90% |
| MarkerInserter | 85% |
| MarkerParser | 90% |
| BlockIdGenerator | 100% |
| StateSerializer | 85% |

### 8.2 å…³é”®æµ‹è¯•åœºæ™¯

#### åœºæ™¯ 1ï¼šåŸºæœ¬ Diff æµç¨‹

```typescript
test('should create diff blocks when AI modifies file', async () => {
  const oldContent = 'const x = 1;';
  const newContent = 'const x = 2;';

  await service.handleAIEdit('test.ts', oldContent, newContent);

  const blocks = service.getBlocks('test.ts');
  expect(blocks).toHaveLength(1);
  expect(blocks[0].baseContent).toBe(oldContent);
  expect(blocks[0].currentContent).toBe(newContent);
});
```

#### åœºæ™¯ 2ï¼šåŒä½ç½®å¤šæ¬¡ä¿®æ”¹

```typescript
test('should update base content after accepting block', async () => {
  // ç¬¬ä¸€æ¬¡ä¿®æ”¹
  await service.handleAIEdit('test.ts', 'const x = 1;', 'const x = 2;');
  const block1 = service.getBlocks('test.ts')[0];

  // æ¥å—
  await service.acceptBlock(block1.id);

  // ç¬¬äºŒæ¬¡ä¿®æ”¹åŒä¸€ä½ç½®
  await service.handleAIEdit('test.ts', 'const x = 2;', 'const x = 3;');
  const block2 = service.getBlocks('test.ts')[0];

  // éªŒè¯åŸºå‡†æ˜¯ä¸Šæ¬¡æ¥å—çš„å†…å®¹
  expect(block2.baseContent).toBe('const x = 2;');
  expect(block2.baseType).toBe('accepted');
  expect(block2.baseBlockId).toBe(block1.id);
});
```

#### åœºæ™¯ 3ï¼šMarker æ ¼å¼æ ¡éªŒ

```typescript
test('should detect invalid marker format', () => {
  const invalidContent = `
    <<<<<<< Original [block-123]
    old content
    >>>>>>> Claude's Change
  `;  // ç¼ºå°‘ =======

  const result = validator.validate(invalidContent);
  expect(result.valid).toBe(false);
  expect(result.errors[0].type).toBe('incomplete_marker');
});
```

#### åœºæ™¯ 4ï¼šå¤§æ–‡ä»¶æ€§èƒ½

```typescript
test('should handle large file efficiently', async () => {
  const largeFile = generateLargeFile(10000);  // 10000 è¡Œ
  const modified = modifyLines(largeFile, [100, 500, 1000]);

  const start = performance.now();
  await service.handleAIEdit('large.ts', largeFile, modified);
  const duration = performance.now() - start;

  expect(duration).toBeLessThan(2000);  // < 2s
});
```

#### åœºæ™¯ 5ï¼šçŠ¶æ€æŒä¹…åŒ–

```typescript
test('should restore state after restart', async () => {
  // åˆ›å»º blocks
  await service.handleAIEdit('test.ts', 'old', 'new');
  const originalBlocks = service.getBlocks('test.ts');

  // æ¨¡æ‹Ÿé‡å¯
  await service.dispose();
  const newService = new DiffPreviewService();
  await newService.restoreState();

  // éªŒè¯çŠ¶æ€æ¢å¤
  const restoredBlocks = newService.getBlocks('test.ts');
  expect(restoredBlocks).toEqual(originalBlocks);
});
```

### 8.3 é›†æˆæµ‹è¯•

#### ä¸ ClaudeAgentService é›†æˆ

```typescript
test('should integrate with ClaudeAgentService', async () => {
  const agentService = new ClaudeAgentService();
  const diffService = new DiffPreviewService();

  // æ¨¡æ‹Ÿ AI æ‰§è¡Œ Write å·¥å…·
  const toolInput = {
    file_path: 'test.ts',
    content: 'new content'
  };

  // ç›‘å¬æ–‡ä»¶ä¿®æ”¹
  const blocks = await new Promise(resolve => {
    setTimeout(() => {
      resolve(diffService.getBlocks('test.ts'));
    }, 100);
  });

  await agentService.executeTool('Write', toolInput);

  expect(blocks).toHaveLength(1);
});
```

### 8.4 E2E æµ‹è¯•

```typescript
test('E2E: complete user workflow', async () => {
  // 1. AI ä¿®æ”¹æ–‡ä»¶
  await simulateAIEdit('test.ts', 'old', 'new');

  // 2. ç”¨æˆ·æŸ¥çœ‹ diff
  const editor = await vscode.window.showTextDocument('test.ts');
  expect(editor.document.getText()).toContain('<<<<<<<');

  // 3. ç”¨æˆ·æ¥å—ä¿®æ”¹
  await vscode.commands.executeCommand('claudix.acceptDiffBlock', blockId);

  // 4. éªŒè¯ markers å·²ç§»é™¤
  expect(editor.document.getText()).not.toContain('<<<<<<<');

  // 5. éªŒè¯æ–‡ä»¶å†…å®¹æ­£ç¡®
  expect(editor.document.getText()).toBe('new');
});
```

---

## 9. é£é™©è¯„ä¼°ä¸ç¼“è§£

### 9.1 æŠ€æœ¯é£é™©

| é£é™© | å½±å“ | æ¦‚ç‡ | ç¼“è§£æªæ–½ |
|-----|------|------|---------|
| æ— é™å¾ªç¯ï¼ˆæ’å…¥ markers è§¦å‘ç›‘å¬ï¼‰ | é«˜ | ä¸­ | ä¸¥æ ¼çš„æ ‡è®°ä½ç®¡ç† + å•å…ƒæµ‹è¯• |
| å¤§æ–‡ä»¶æ€§èƒ½é—®é¢˜ | ä¸­ | é«˜ | Myers Diff + è™šæ‹Ÿæ»šåŠ¨ + é™åˆ¶ block æ•°é‡ |
| Marker æ ¼å¼è¢«ç ´å | ä¸­ | ä¸­ | å®æ—¶æ ¡éªŒ + è‡ªåŠ¨æ¸…ç† + ç”¨æˆ·æç¤º |
| çŠ¶æ€ä¸ä¸€è‡´ï¼ˆå†…å­˜ vs ç£ç›˜ï¼‰ | é«˜ | ä½ | å®šæ—¶åŒæ­¥ + å“ˆå¸Œæ ¡éªŒ |
| ç”¨æˆ·æ‰‹åŠ¨ç¼–è¾‘å†²çª | ä½ | é«˜ | å®¹é”™å¤„ç† + æ¸…æ™°çš„æç¤º |

### 9.2 ç”¨æˆ·ä½“éªŒé£é™©

| é£é™© | å½±å“ | ç¼“è§£æªæ–½ |
|-----|------|---------|
| ä¸ç†è§£ Conflict Markers | ä¸­ | é¦–æ¬¡ä½¿ç”¨å¼•å¯¼ + æ–‡æ¡£è¯´æ˜ |
| è¯¯æ“ä½œï¼ˆé”™è¯¯æ¥å—/æ‹’ç»ï¼‰ | ä¸­ | æ’¤é”€åŠŸèƒ½ï¼ˆCmd+Zï¼‰ + ç¡®è®¤å¯¹è¯æ¡†ï¼ˆå¯é€‰ï¼‰ |
| è§†è§‰æ··ä¹±ï¼ˆå¤ªå¤š markersï¼‰ | ä½ | é™åˆ¶æ˜¾ç¤ºæ•°é‡ + æŠ˜å åŠŸèƒ½ |
| æ€§èƒ½å¡é¡¿ | é«˜ | æ€§èƒ½ç›‘æ§ + é™çº§ç­–ç•¥ |

### 9.3 å…¼å®¹æ€§é£é™©

| é£é™© | ç¼“è§£æªæ–½ |
|-----|---------|
| VSCode API å˜æ›´ | ä½¿ç”¨ç¨³å®š API + ç‰ˆæœ¬æ£€æµ‹ |
| ä¸å…¶ä»–æ‰©å±•å†²çª | å‘½åç©ºé—´éš”ç¦» + ç¤¼è²Œçš„ API ä½¿ç”¨ |
| è·¨å¹³å°å·®å¼‚ï¼ˆWindows/Mac/Linuxï¼‰ | è·¯å¾„è§„èŒƒåŒ– + å¹³å°ç‰¹å®šæµ‹è¯• |

---

## 10. é‡Œç¨‹ç¢‘ä¸äº¤ä»˜ç‰©

### 10.1 å¼€å‘é‡Œç¨‹ç¢‘

| é˜¶æ®µ | ç›®æ ‡ | äº¤ä»˜ç‰© | é¢„ä¼°æ—¶é—´ |
|-----|------|--------|---------|
| M1ï¼šåŸºç¡€æ¶æ„ | æ­å»ºæ ¸å¿ƒæ¨¡å—å’Œæ•°æ®ç»“æ„ | DiffStateManager, DiffBlock æ¨¡å‹ | 2 å¤© |
| M2ï¼šDiff å¼•æ“ | å®ç° Myers Diff ç®—æ³• | DiffCalculator, MyersDiff | 2 å¤© |
| M3ï¼šMarker ç³»ç»Ÿ | å®ç° marker æ’å…¥/è§£æ/æ ¡éªŒ | MarkerInserter, MarkerParser | 2 å¤© |
| M4ï¼šUI å±‚ | å®ç°è£…é¥°å™¨å’Œ CodeLens | DecorationManager, CodeLensProvider | 2 å¤© |
| M5ï¼šé›†æˆä¸æµ‹è¯• | ä¸ ClaudeAgentService é›†æˆ | å®Œæ•´å·¥ä½œæµ | 2 å¤© |
| M6ï¼šä¼˜åŒ–ä¸æ‰“ç£¨ | æ€§èƒ½ä¼˜åŒ–ã€çŠ¶æ€æŒä¹…åŒ– | ç”Ÿäº§å°±ç»ªç‰ˆæœ¬ | 3 å¤© |

**æ€»é¢„ä¼°**ï¼š13 ä¸ªå·¥ä½œæ—¥

### 10.2 äº¤ä»˜ç‰©æ¸…å•

- [ ] å®Œæ•´çš„æºä»£ç ï¼ˆçº¦ 2000 è¡Œï¼‰
- [ ] å•å…ƒæµ‹è¯•ï¼ˆè¦†ç›–ç‡ â‰¥ 85%ï¼‰
- [ ] é›†æˆæµ‹è¯•å¥—ä»¶
- [ ] ç”¨æˆ·æ–‡æ¡£ï¼ˆä½¿ç”¨æŒ‡å—ï¼‰
- [ ] å¼€å‘è€…æ–‡æ¡£ï¼ˆæ¶æ„è¯´æ˜ï¼‰
- [ ] æ€§èƒ½æµ‹è¯•æŠ¥å‘Š
- [ ] å·²çŸ¥é—®é¢˜å’Œé™åˆ¶è¯´æ˜

---

## 11. å‚è€ƒæ–‡æ¡£

### 11.1 VSCode å®˜æ–¹æ–‡æ¡£

1. **TextDocument API**
   - URL: https://code.visualstudio.com/api/references/vscode-api#TextDocument
   - ç”¨é€”ï¼šæ–‡æ¡£å†…å®¹è¯»å–ã€ä¿®æ”¹ç›‘å¬

2. **TextEditorDecorationType API**
   - URL: https://code.visualstudio.com/api/references/vscode-api#TextEditorDecorationType
   - ç”¨é€”ï¼šçº¢ç»¿è£…é¥°å™¨å®ç°

3. **CodeLensProvider API**
   - URL: https://code.visualstudio.com/api/references/vscode-api#CodeLensProvider
   - ç”¨é€”ï¼šæ¥å—/æ‹’ç»æŒ‰é’®å®ç°

4. **WorkspaceEdit API**
   - URL: https://code.visualstudio.com/api/references/vscode-api#WorkspaceEdit
   - ç”¨é€”ï¼šæ–‡ä»¶ä¿®æ”¹æ“ä½œ

5. **onDidChangeTextDocument Event**
   - URL: https://code.visualstudio.com/api/references/vscode-api#workspace.onDidChangeTextDocument
   - ç”¨é€”ï¼šæ–‡ä»¶ä¿®æ”¹ç›‘å¬

6. **Configuration API**
   - URL: https://code.visualstudio.com/api/references/vscode-api#workspace.getConfiguration
   - ç”¨é€”ï¼šç”¨æˆ·é…ç½®ç®¡ç†

### 11.2 Diff ç®—æ³•å‚è€ƒ

1. **Myers Diff ç®—æ³•è®ºæ–‡**
   - æ ‡é¢˜: "An O(ND) Difference Algorithm and Its Variations"
   - ä½œè€…: Eugene W. Myers
   - å¹´ä»½: 1986
   - URL: http://www.xmailserver.org/diff2.pdf

2. **diff NPM åŒ…**
   - URL: https://www.npmjs.com/package/diff
   - ç‰ˆæœ¬: ^5.1.0
   - ç”¨é€”ï¼šæˆç†Ÿçš„ Diff ç®—æ³•å®ç°

3. **fast-diff åº“**
   - URL: https://www.npmjs.com/package/fast-diff
   - ç”¨é€”ï¼šé«˜æ€§èƒ½ diff å®ç°ï¼ˆå¤‡é€‰ï¼‰

### 11.3 Git Conflict Markers è§„èŒƒ

1. **Git å®˜æ–¹æ–‡æ¡£**
   - URL: https://git-scm.com/docs/git-merge#_how_conflicts_are_presented
   - ç”¨é€”ï¼šConflict Marker æ ¼å¼å‚è€ƒ

2. **VSCode Git æ‰©å±•æºç **
   - URL: https://github.com/microsoft/vscode/tree/main/extensions/git
   - ç”¨é€”ï¼šå­¦ä¹ å¦‚ä½•å¤„ç† conflict markers

### 11.4 ç±»ä¼¼äº§å“å‚è€ƒ

1. **Cursor ç¼–è¾‘å™¨**
   - URL: https://cursor.sh
   - å‚è€ƒç‚¹ï¼šå·®å¼‚é¢„è§ˆ UIã€äº¤äº’æµç¨‹

2. **GitHub Copilot**
   - URL: https://github.com/features/copilot
   - å‚è€ƒç‚¹ï¼šå†…è”å»ºè®®æ˜¾ç¤º

3. **GitLens æ‰©å±•**
   - URL: https://marketplace.visualstudio.com/items?itemName=eamodio.gitlens
   - å‚è€ƒç‚¹ï¼šCodeLens æŒ‰é’®è®¾è®¡

### 11.5 Claude Agent SDK æ–‡æ¡£

1. **SDK å®˜æ–¹æ–‡æ¡£**
   - URL: https://github.com/anthropics/claude-agent-sdk
   - ç‰ˆæœ¬: 2.0.42
   - ç”¨é€”ï¼šå·¥å…·ç³»ç»Ÿé›†æˆ

2. **Permission System**
   - æ–‡ä»¶: `node_modules/@anthropic-ai/claude-agent-sdk/sdk.d.ts`
   - ç”¨é€”ï¼šç†è§£æƒé™æ£€æŸ¥æµç¨‹

3. **Tool Schemas**
   - æ–‡ä»¶: `node_modules/@anthropic-ai/claude-agent-sdk/sdk-tools.d.ts`
   - ç”¨é€”ï¼šWrite/Edit å·¥å…·çš„è¾“å…¥è¾“å‡ºå®šä¹‰

### 11.6 TypeScript å‚è€ƒ

1. **TypeScript å®˜æ–¹æ‰‹å†Œ**
   - URL: https://www.typescriptlang.org/docs/handbook/intro.html
   - ç”¨é€”ï¼šç±»å‹å®šä¹‰æœ€ä½³å®è·µ

2. **Type Challenges**
   - URL: https://github.com/type-challenges/type-challenges
   - ç”¨é€”ï¼šå¤æ‚ç±»å‹å®šä¹‰å‚è€ƒ

### 11.7 æ€§èƒ½ä¼˜åŒ–å‚è€ƒ

1. **VSCode Performance Wiki**
   - URL: https://github.com/microsoft/vscode/wiki/Performance-Issues
   - ç”¨é€”ï¼šæ€§èƒ½ä¼˜åŒ–æœ€ä½³å®è·µ

2. **Web Vitals**
   - URL: https://web.dev/vitals/
   - ç”¨é€”ï¼šæ€§èƒ½æŒ‡æ ‡å®šä¹‰

3. **React Virtualization**
   - URL: https://github.com/bvaughn/react-virtualized
   - ç”¨é€”ï¼šè™šæ‹Ÿæ»šåŠ¨å®ç°å‚è€ƒ

### 11.8 æµ‹è¯•æ¡†æ¶æ–‡æ¡£

1. **Jest å®˜æ–¹æ–‡æ¡£**
   - URL: https://jestjs.io/docs/getting-started
   - ç”¨é€”ï¼šå•å…ƒæµ‹è¯•æ¡†æ¶

2. **@vscode/test-electron**
   - URL: https://www.npmjs.com/package/@vscode/test-electron
   - ç”¨é€”ï¼šVSCode æ‰©å±•é›†æˆæµ‹è¯•

---

## 12. é™„å½•

### 12.1 æœ¯è¯­è¡¨

| æœ¯è¯­ | å®šä¹‰ |
|-----|------|
| Diff Block | å•ä¸ªä¿®æ”¹å—ï¼ŒåŒ…å«åŸå§‹å†…å®¹å’Œä¿®æ”¹å†…å®¹çš„å¯¹æ¯” |
| Conflict Marker | å·®å¼‚æ ‡è®°ï¼Œæ ¼å¼ç±»ä¼¼ Git merge conflict |
| Base Content | å¯¹æ¯”åŸºå‡†å†…å®¹ï¼Œå¯èƒ½æ˜¯åŸå§‹å†…å®¹æˆ–ä¸Šæ¬¡æ¥å—çš„å†…å®¹ |
| CodeLens | VSCode æä¾›çš„ä»£ç ä¸Šæ–¹æ‚¬æµ®æŒ‰é’® |
| Decoration | VSCode æä¾›çš„æ–‡æœ¬è£…é¥°åŠŸèƒ½ï¼ˆèƒŒæ™¯è‰²ã€å‰ç¼€ç¬¦å·ç­‰ï¼‰ |
| Myers Diff | ä¸€ç§é«˜æ•ˆçš„ diff ç®—æ³•ï¼Œå¤æ‚åº¦ O(n*d) |
| Virtual Scroll | è™šæ‹Ÿæ»šåŠ¨ï¼Œä»…æ¸²æŸ“å¯è§åŒºåŸŸï¼Œæå‡æ€§èƒ½ |
| State Persistence | çŠ¶æ€æŒä¹…åŒ–ï¼Œä¿å­˜åˆ°ç£ç›˜ä»¥é˜²é‡å¯ä¸¢å¤± |

### 12.2 ç¤ºä¾‹ä»£ç ç‰‡æ®µ

#### ç”Ÿæˆ Block ID

```typescript
import { createHash } from 'crypto';

function generateBlockId(filePath: string, startLine: number): string {
  const fileHash = createHash('md5')
    .update(filePath)
    .digest('hex')
    .slice(0, 8);
  const timestamp = Date.now();
  return `block-${fileHash}-L${startLine}-T${timestamp}`;
}

// ç¤ºä¾‹è¾“å‡º: "block-a1b2c3d4-L15-T1700123456789"
```

#### Myers Diff ä½¿ç”¨ç¤ºä¾‹

```typescript
import { diffLines } from 'diff';

function calculateDiff(oldContent: string, newContent: string): DiffBlock[] {
  const changes = diffLines(oldContent, newContent);
  const blocks: DiffBlock[] = [];

  let currentLine = 0;
  for (const change of changes) {
    if (change.added || change.removed) {
      blocks.push({
        startLine: currentLine,
        endLine: currentLine + change.count,
        deletedLines: change.removed ? change.value.split('\n') : [],
        addedLines: change.added ? change.value.split('\n') : [],
        changeType: change.added ? 'add' : change.removed ? 'delete' : 'modify'
      });
    }

    if (!change.added) {
      currentLine += change.count;
    }
  }

  return blocks;
}
```

#### Conflict Marker æ„å»º

```typescript
function buildConflictMarker(block: DiffBlock): string {
  const lines: string[] = [];

  lines.push(`<<<<<<< Original [${block.id}]`);
  lines.push(...block.deletedLines);
  lines.push('=======');
  lines.push(...block.addedLines);
  lines.push(">>>>>>> Claude's Change");

  return lines.join('\n');
}

// ç¤ºä¾‹è¾“å‡º:
// <<<<<<< Original [block-abc]
// const x = 1;
// =======
// const x = 2;
// >>>>>>> Claude's Change
```

### 12.3 é…ç½®ç¤ºä¾‹

#### .vscode/settings.json

```json
{
  "claudix.diffPreview.enabled": true,
  "claudix.diffPreview.maxBlocksPerFile": 30,
  "claudix.diffPreview.diffAlgorithm": "myers",
  "claudix.diffPreview.colorScheme": {
    "added": "rgba(0, 255, 0, 0.15)",
    "deleted": "rgba(255, 0, 0, 0.15)",
    "marker": "rgba(128, 128, 128, 0.1)"
  },
  "claudix.diffPreview.shortcuts": {
    "accept": "cmd+k",
    "reject": "cmd+shift+k",
    "nextBlock": "cmd+]",
    "prevBlock": "cmd+["
  }
}
```

#### keybindings.json

```json
[
  {
    "key": "cmd+k",
    "command": "claudix.acceptDiffBlock",
    "when": "editorTextFocus && claudix.hasDiffBlocks"
  },
  {
    "key": "cmd+shift+k",
    "command": "claudix.rejectDiffBlock",
    "when": "editorTextFocus && claudix.hasDiffBlocks"
  },
  {
    "key": "cmd+]",
    "command": "claudix.nextDiffBlock",
    "when": "editorTextFocus && claudix.hasDiffBlocks"
  },
  {
    "key": "cmd+[",
    "command": "claudix.prevDiffBlock",
    "when": "editorTextFocus && claudix.hasDiffBlocks"
  }
]
```

---

## 13. æ–‡æ¡£å˜æ›´å†å²

| ç‰ˆæœ¬ | æ—¥æœŸ | ä½œè€… | å˜æ›´è¯´æ˜ |
|-----|------|------|---------|
| v1.0 | 2025-11-16 | Claude Code | åˆå§‹ç‰ˆæœ¬ï¼Œå®Œæ•´éœ€æ±‚å®šä¹‰ |
| v1.1 | 2025-11-16 | Claude Code | æ·»åŠ å·¥ä½œæ¨¡å¼é›†æˆï¼ˆ2.9 ç« èŠ‚ï¼‰ï¼Œæ‰©å±• 6.2 é…ç½®é€‰é¡¹ï¼Œæ˜ç¡® default/agent/ask ä¸‰ç§æ¨¡å¼çš„å·®å¼‚é¢„è§ˆè¡Œä¸º |

---

## 14. å®¡æ‰¹ä¸ç­¾å­—

| è§’è‰² | å§“å | ç­¾å­— | æ—¥æœŸ |
|-----|------|------|------|
| äº§å“ç»ç† | | | |
| æŠ€æœ¯è´Ÿè´£äºº | | | |
| å¼€å‘å·¥ç¨‹å¸ˆ | | | |
| æµ‹è¯•å·¥ç¨‹å¸ˆ | | | |

---

**æ–‡æ¡£ç»“æŸ**
